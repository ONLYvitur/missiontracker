<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>××¢×§×‘ ××©×™××•×ª ××ª×§×“×</title>
  <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <meta name="robots" content="noindex" />
  <style>
    html, body { font-family: 'Varela Round', Arial, sans-serif; }
    body { min-height: 100vh; background: linear-gradient(180deg, #e3f0fc 0%, #ffffff 100%); }
    .rtl { direction: rtl; text-align: right; }
    .ltr { direction: ltr; text-align: left; }
    .sticky-header { position: sticky; top: 0; z-index: 10; background: #e3f0fc; }
    .mission-card { transition: box-shadow 0.2s, transform 0.2s; min-width: 260px;}
    .mission-card:hover { box-shadow: 0 8px 28px 2px #b0c9e1b0; transform: translateY(-2px) scale(1.01);}
    .input-search { font-size: 1.05em;}
    .priority-high { color:#fff; background: #e53e3e; }
    .priority-medium { color:#fff; background: #ecc94b; }
    .priority-low { color:#fff; background: #38a169; }
    .progress-bar { height: 0.7rem; border-radius: 8px;}
    .loader {
      border: 4px solid #e3e3e3;
      border-radius: 50%;
      border-top: 4px solid #3182ce;
      width: 38px; height: 38px;
      animation: spin 1s linear infinite;
      margin: 2rem auto;
      display:block;
    }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
    body.dark { background: #111827; color: #e5e7eb; }
    body.dark .bg-white { background: #1f2937 !important; color: #e5e7eb !important; }
    body.dark .bg-gray-50 { background: #111827 !important; }
    body.dark .text-blue-800 { color: #60a5fa !important; }
    body.dark .text-gray-500 { color: #a3a3a3 !important; }
    body.dark .shadow { box-shadow: 0 2px 12px #0009 !important; }
    body.dark input, body.dark select, body.dark textarea { background: #334155 !important; color: #e5e7eb !important; }
    body.dark .status-badge.bg-gray-200 { background: #374151 !important;}
    body.dark .status-badge.bg-green-200 { background: #166534 !important; color: #d1fae5 !important;}
    body.dark .status-badge.bg-yellow-200 { background: #7c6f1c !important; color:#fef08a !important;}
    body.dark .bg-blue-50 { background: #1e40af !important; color: #dbeafe !important;}
    body.dark .bg-blue-100 { background: #2563eb !important; color: #dbeafe !important;}
  </style>
</head>
<body class="bg-gray-50 text-gray-800 flex flex-col items-center py-3 px-1">
  <button id="darkToggle" class="fixed top-2 left-3 z-50 rounded-full bg-white dark:bg-gray-800 shadow p-2 transition hover:bg-blue-100" title="××¦×‘ ×›×”×”/×‘×”×™×¨">
    <span id="darkIcon">ğŸŒ™</span>
  </button>
  <div class="w-full max-w-7xl">
    <header class="flex items-center justify-between mb-4 flex-row-reverse sticky-header shadow-md py-3 px-2 rounded-xl">
      <div>
        <h1 class="text-3xl font-black tracking-tight text-blue-800 text-right mb-0">××¢×§×‘ ××©×™××•×ª ××ª×§×“×</h1>
        <div class="text-base text-gray-500 mt-1" id="personalGreeting"></div>
      </div>
      <span id="avatarWrap">
        <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" class="rounded-full border shadow w-12 h-12 object-cover" id="avatar" alt="××•×•××˜×¨"/>
        <input type="file" id="avatarUpload" class="hidden" accept="image/*"/>
      </span>
    </header>
    <div id="authBox" class="bg-white p-6 rounded-xl shadow max-w-md w-full mb-8">
      <h2 class="text-xl font-semibold mb-4 text-right">×”×ª×—×‘×¨×•×ª / ×”×¨×©××”</h2>
      <input id="authEmail" type="email" placeholder="××™××™×™×œ" class="border p-2 w-full mb-2 rounded text-right" autocomplete="username" />
      <input id="authPass" type="password" placeholder="×¡×™×¡××”" class="border p-2 w-full mb-2 rounded text-right" autocomplete="current-password" />
      <div class="flex gap-2 mb-2 flex-row-reverse">
        <button id="loginBtn" class="bg-blue-600 text-white px-4 py-2 rounded">×”×ª×—×‘×¨</button>
        <button id="registerBtn" class="bg-gray-600 text-white px-4 py-2 rounded">×”×¨×©×</button>
        <button id="logoutBtn" class="bg-red-600 text-white px-4 py-2 rounded hidden">×”×ª× ×ª×§</button>
      </div>
      <div id="authStatus" class="text-sm text-gray-700 mt-3 text-right"></div>
    </div>
    <div class="flex flex-col md:flex-row gap-2 mb-4 items-center justify-between flex-row-reverse">
      <input id="searchInput" placeholder="×—×™×¤×•×© ××©×™××”..." class="border input-search p-2 w-full rounded text-right shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-200 transition md:w-72"/>
      <select id="priorityFilter" class="border rounded p-2 text-right">
        <option value="">×¡× ×Ÿ ×œ×¤×™ ×¢×“×™×¤×•×ª</option>
        <option value="high">×’×‘×•×”×”</option>
        <option value="medium">×‘×™× ×•× ×™×ª</option>
        <option value="low">× ××•×›×”</option>
      </select>
      <button id="bulkArchiveBtn" class="bg-yellow-200 hover:bg-yellow-300 text-yellow-900 font-bold px-4 py-2 rounded-xl shadow transition hidden">××¨×›×•×‘ × ×‘×—×¨×™×</button>
      <button id="bulkDeleteBtn" class="bg-red-200 hover:bg-red-300 text-red-900 font-bold px-4 py-2 rounded-xl shadow transition hidden">××—×™×§×” × ×‘×—×¨×™×</button>
      <button id="addBtn" class="bg-blue-600 hover:bg-blue-700 transition text-white px-5 py-2 rounded-xl font-semibold shadow">×”×•×¡×£ ××©×™××”</button>
      <button id="exportExcelBtn" class="admin-only bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-semibold shadow">×™×™×¦× ×œ××§×¡×œ</button>
      <button id="exportPdfBtn" class="bg-pink-500 hover:bg-pink-600 text-white px-4 py-2 rounded font-semibold shadow">PDF</button>
      <button id="logoutBtnHeader" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded shadow font-bold">×”×ª× ×ª×§</button>
    </div>
    <div id="categoryTabs" class="flex gap-2 flex-row-reverse mb-4">
      <button class="cat-tab px-4 py-2 rounded font-semibold" data-cat="all">×”×›×œ</button>
      <button class="cat-tab px-4 py-2 rounded font-semibold" data-cat="×ª×§×©×•×‘">×ª×§×©×•×‘</button>
      <button class="cat-tab px-4 py-2 rounded font-semibold" data-cat="×œ×•×’×™×¡×˜×™×§×”">×œ×•×’×™×¡×˜×™×§×”</button>
      <button class="cat-tab px-4 py-2 rounded font-semibold" data-cat="×¨×›×‘">×¨×›×‘</button>
      <button class="cat-tab px-4 py-2 rounded font-semibold" data-cat="××˜×‘×—">××˜×‘×—</button>
      <button class="cat-tab px-4 py-2 rounded font-semibold" data-cat="××—× ×”">××—× ×”</button>
      <button class="cat-tab px-4 py-2 rounded font-semibold" data-cat="archive">××¨×›×™×•×Ÿ</button>
    </div>
    <div id="missionsWrap" class="mt-6">
      <div id="loader" class="loader"></div>
      <div id="missions" class="grid gap-5"></div>
    </div>
  </div>
    <!-- Mission Modal (with chat inside, feedback removed) -->
    <div id="missionModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-gray-900 dark:text-gray-100 p-6 rounded-xl max-w-lg w-full shadow-xl relative">
        <button class="absolute left-5 top-5 text-lg text-gray-500 hover:text-red-500" onclick="document.getElementById('missionModal').classList.add('hidden')">âœ•</button>
        <h2 id="modalTitle" class="text-xl font-bold mb-2 text-right">××©×™××” ×—×“×©×”</h2>
        <form id="missionForm" class="space-y-3">
          <input id="mTitle" type="text" required class="border rounded p-2 w-full text-right" placeholder="×›×•×ª×¨×ª ××©×™××”">
          <textarea id="mDesc" class="border rounded p-2 w-full text-right" placeholder="×ª×™××•×¨"></textarea>
          <input id="mDue" type="date" class="border rounded p-2 w-full text-right">
          <select id="mCategory" class="border rounded p-2 w-full text-right">
            <!-- options built dynamically in JS -->
          </select>
          <select id="mPriority" class="border rounded p-2 w-full text-right">
            <option value="">×¢×“×™×¤×•×ª</option>
            <option value="high">×’×‘×•×”×”</option>
            <option value="medium">×‘×™× ×•× ×™×ª</option>
            <option value="low">× ××•×›×”</option>
          </select>
          <input id="mAssignee" type="text" class="border rounded p-2 w-full text-right" placeholder="××©×•×™×š ×œ...">
          <div>
            <label class="font-bold">×¦'×§×œ×™×¡×˜</label>
            <textarea id="mChecklist" class="border rounded p-2 w-full text-right" placeholder="×›×œ ×©×•×¨×”=×¡×¢×™×£"></textarea>
          </div>
          <div>
            <label class="font-bold">×”×¢×œ×” ×§×•×‘×¥</label>
            <input id="mFile" type="file" class="border rounded p-2 w-full text-right">
          </div>
          <div class="flex items-center gap-2 flex-row-reverse">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">×©××•×¨</button>
            <button type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded" onclick="document.getElementById('missionModal').classList.add('hidden')">×‘×™×˜×•×œ</button>
          </div>
        </form>
        <!-- Chat section inside mission modal -->
        <div class="mt-6">
          <h3 class="text-lg font-bold mb-2 text-right">×¦'××˜ ××©×™××”</h3>
          <div id="chatMessages" class="flex-1 overflow-y-auto mb-3 border rounded p-2 bg-gray-50 dark:bg-gray-800" style="max-height:150px"></div>
          <form id="chatForm" class="flex gap-2 flex-row-reverse">
            <input id="chatInput" type="text" required class="border rounded p-2 flex-1 text-right" placeholder="×›×ª×•×‘ ×”×•×“×¢×”...">
            <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">×©×œ×—</button>
          </form>
        </div>
      </div>
    </div>
    <script>
    // ---- Firebase Config ----
    const firebaseConfig = {
      apiKey: "AIzaSyA7B7rovUIpikVGepAqQI2s3Y_xePEwkSA",
      authDomain: "missiontracker-52bb7.firebaseapp.com",
      projectId: "missiontracker-52bb7",
      storageBucket: "missiontracker-52bb7.appspot.com",
      messagingSenderId: "1029768338042",
      appId: "1:1029768338042:web:23b2a0539e0aab53daf9c3",
      measurementId: "G-TNVPW8RETF"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ---- Category Permissions ----
    // Map emails to allowed categories
    const allCategories = ["×ª×§×©×•×‘", "×œ×•×’×™×¡×˜×™×§×”", "×¨×›×‘", "××˜×‘×—", "××—× ×”"];
    const userCategoryPermissions = {
      "matanel@mission.com": ["××—× ×”"],
      "anan@mission.com": ["×ª×§×©×•×‘"],
      "hagai@mission.com": ["××˜×‘×—"],
      "walla@mission.com": ["×¨×›×‘"],
      "yosef@mission.com": ["×œ×•×’×™×¡×˜×™×§×”"],
      "kfir@mission.com": allCategories
    };

    // ---- Dark Mode ----
    (function(){
      const darkToggle = document.getElementById('darkToggle');
      darkToggle.onclick = function() {
        document.body.classList.toggle('dark');
        localStorage.setItem('task_dark', document.body.classList.contains('dark') ? '1' : '0');
        document.getElementById('darkIcon').textContent = document.body.classList.contains('dark') ? "â˜€ï¸" : "ğŸŒ™";
      };
      if(localStorage.getItem('task_dark') === '1') {
        document.body.classList.add('dark');
        document.getElementById('darkIcon').textContent = "â˜€ï¸";
      }
    })();

    // ---- Auth ----
    let currentUser = null;
    function updateAuthUI(user) {
      currentUser = user;
      document.getElementById('authBox').style.display = user ? 'none' : '';
      document.getElementById('logoutBtn').classList.toggle('hidden', !user);
      document.getElementById('logoutBtnHeader').classList.toggle('hidden', !user);
      document.getElementById('personalGreeting').textContent = user ? `×©×œ×•×, ${user.email || user.displayName || "××©×ª××©"}!` : '';
      if(user && user.photoURL) document.getElementById('avatar').src = user.photoURL;
      if(user) loadMissions();
    }
    auth.onAuthStateChanged(updateAuthUI);

    document.getElementById('loginBtn').onclick = async ()=>{
      let email = document.getElementById('authEmail').value;
      let pass = document.getElementById('authPass').value;
      try {
        await auth.signInWithEmailAndPassword(email, pass);
      } catch(e) {
        document.getElementById('authStatus').textContent = "×©×’×™××”: "+e.message;
      }
    };
    document.getElementById('registerBtn').onclick = async ()=>{
      let email = document.getElementById('authEmail').value;
      let pass = document.getElementById('authPass').value;
      try {
        await auth.createUserWithEmailAndPassword(email, pass);
      } catch(e) {
        document.getElementById('authStatus').textContent = "×©×’×™××”: "+e.message;
      }
    };
    document.getElementById('logoutBtn').onclick = ()=>auth.signOut();
    document.getElementById('logoutBtnHeader').onclick = ()=>auth.signOut();

    // Avatar upload
    document.getElementById('avatar').onclick = ()=>document.getElementById('avatarUpload').click();
    document.getElementById('avatarUpload').onchange = async function(e) {
      if(!currentUser) return;
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = async function(evt) {
        await currentUser.updateProfile({ photoURL: evt.target.result });
        document.getElementById('avatar').src = evt.target.result;
      };
      reader.readAsDataURL(file);
    };

    // ---- Missions Data & UI ----
    let missions = [];
    let filteredMissions = [];
    let selectedMissions = [];
    let editMissionId = null;
    let currentCategory = "all";

    function renderMissions() {
      const missionsEl = document.getElementById('missions');
      missionsEl.innerHTML = "";
      if(filteredMissions.length === 0) {
        missionsEl.innerHTML = `<div class="text-center text-gray-400 mt-10">××™×Ÿ ××©×™××•×ª ×œ×ª×¦×•×’×”</div>`;
        return;
      }
      filteredMissions.forEach(m => {
        // Permission check for edit/delete
        let allowedCategories = allCategories;
        let canEditDelete = false;
        if (currentUser && userCategoryPermissions[currentUser.email]) {
          allowedCategories = userCategoryPermissions[currentUser.email];
        }
        if (allowedCategories.includes(m.category)) canEditDelete = true;
        missionsEl.innerHTML += `
        <div class="mission-card bg-white p-4 rounded-xl shadow flex flex-col gap-2 border border-gray-100 relative">
          <div class="flex items-center justify-between flex-row-reverse">
            <span class="text-lg font-bold">${m.title}</span>
            <span class="text-xs px-2 py-1 rounded status-badge ${m.status==='done'?'bg-green-200':'bg-gray-200'}">${m.status==='done'?'×‘×•×¦×¢': (m.status==='archived'?'×‘××¨×›×™×•×Ÿ':'×¤×¢×™×œ')}</span>
          </div>
          <div class="text-sm text-gray-600">${m.desc||''}</div>
          <div class="flex items-center gap-2 flex-row-reverse">
            <span class="priority-${m.priority} text-xs px-2 py-1 rounded">${m.priority==='high'?'×’×‘×•×”×”':m.priority==='medium'?'×‘×™× ×•× ×™×ª':'× ××•×›×”'}</span>
            <span class="text-gray-500 text-xs">${m.category||''}</span>
            <span class="text-gray-500 text-xs">${m.due||''}</span>
          </div>
          <div class="flex items-center gap-2 flex-row-reverse mt-2">
            ${canEditDelete ? `<button onclick="editMission('${m.id}')" class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">×¢×¨×•×š</button>
            <button onclick="archiveMission('${m.id}')" class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs">${m.status==='archived'?'××—×§ ×¡×•×¤×™×ª':'×”×¢×‘×¨ ×œ××¨×›×™×•×Ÿ'}</button>` : ''}
            <button onclick="openMissionChat('${m.id}')" class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs">×¦'××˜</button>
          </div>
        </div>
        `;
      });
    }

    function filterMissions() {
      const search = document.getElementById('searchInput').value.trim();
      const priority = document.getElementById('priorityFilter').value;
      filteredMissions = missions.filter(m=>{
        let matches = true;
        if(currentCategory !== "all" && currentCategory !== "archive")
          matches = matches && m.category === currentCategory && m.status !== 'archived';
        if(currentCategory === "archive")
          matches = matches && m.status === "archived";
        if(currentCategory === "all")
          matches = matches && m.status !== 'archived';
        if(search)
          matches = matches && (m.title.includes(search)||m.desc.includes(search));
        if(priority)
          matches = matches && m.priority === priority;
        return matches;
      });
      renderMissions();
    }

    async function loadMissions() {
      const snapshot = await db.collection('missions').get();
      missions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      filterMissions();
      document.getElementById('loader').style.display = "none";
    }

    async function saveMissions() {
      if (!currentUser) return;
      for (const m of missions) {
        await db.collection('missions').doc(m.id).set({ ...m, uid: m.uid || currentUser.uid });
      }
      filterMissions();
    }

    // ---- Mission Modal: enforce per-user category permissions ----
    function openMissionModal(editId=null, openChat=false) {
      editMissionId = editId;
      document.getElementById('missionModal').classList.remove('hidden');
      // set allowed categories
      let allowedCategories = allCategories;
      if (currentUser && userCategoryPermissions[currentUser.email]) {
        allowedCategories = userCategoryPermissions[currentUser.email];
      }
      // build category dropdown
      const catSelect = document.getElementById('mCategory');
      catSelect.innerHTML = '<option value="">×§×˜×’×•×¨×™×”</option>' + allowedCategories.map(c =>
        `<option value="${c}">${c}</option>`
      ).join('');
      // fill rest of form
      if(editId) {
        const m = missions.find(x=>x.id===editId);
        // Permission check - can only edit their allowed categories
        if (!allowedCategories.includes(m.category)) {
          alert("××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¢×¨×•×š ××©×™××•×ª ×‘×§×˜×’×•×¨×™×” ×–×•");
          document.getElementById('missionModal').classList.add('hidden');
          return;
        }
        document.getElementById('modalTitle').textContent = "×¢×¨×™×›×ª ××©×™××”";
        document.getElementById('mTitle').value = m.title;
        document.getElementById('mDesc').value = m.desc||'';
        document.getElementById('mDue').value = m.due||'';
        catSelect.value = m.category||'';
        document.getElementById('mPriority').value = m.priority||'';
        document.getElementById('mAssignee').value = m.assignee||'';
        document.getElementById('mChecklist').value = (m.checklist||[]).join('\n');
        loadChatMessages(editId);
      } else {
        document.getElementById('modalTitle').textContent = "××©×™××” ×—×“×©×”";
        document.getElementById('missionForm').reset();
        document.getElementById('chatMessages').innerHTML = "";
      }
      if (openChat && editId) {
        setTimeout(()=>{ document.getElementById('chatInput').focus(); }, 300);
      }
    }
    document.getElementById('addBtn').onclick = ()=>openMissionModal();
    document.getElementById('missionForm').onsubmit = function(e) {
      e.preventDefault();
      // Permission enforcement
      let allowedCategories = allCategories;
      if (currentUser && userCategoryPermissions[currentUser.email]) {
        allowedCategories = userCategoryPermissions[currentUser.email];
      }
      const chosenCat = document.getElementById('mCategory').value;
      if (!allowedCategories.includes(chosenCat)) {
        alert("××™×Ÿ ×œ×š ×”×¨×©××” ×œ×§×˜×’×•×¨×™×” ×–×•");
        return false;
      }
      let m = {
        title: document.getElementById('mTitle').value,
        desc: document.getElementById('mDesc').value,
        due: document.getElementById('mDue').value,
        category: chosenCat,
        priority: document.getElementById('mPriority').value,
        assignee: document.getElementById('mAssignee').value,
        checklist: document.getElementById('mChecklist').value.split('\n').filter(Boolean),
        id: editMissionId||Date.now().toString(),
        status: editMissionId ? (missions.find(x=>x.id===editMissionId)?.status || "active") : "active",
        uid: editMissionId ? (missions.find(x=>x.id===editMissionId)?.uid || currentUser?.uid) : currentUser?.uid
      };
      if(editMissionId) {
        let idx = missions.findIndex(x=>x.id===editMissionId);
        missions[idx] = m;
      } else {
        missions.push(m);
      }
      saveMissions();
      document.getElementById('missionModal').classList.add('hidden');
      editMissionId = null;
      return false;
    };
    window.editMission = function(id){ openMissionModal(id, false); };

    // -- Restrict delete/archive to only allowed categories
    window.archiveMission = function(id) {
      let idx = missions.findIndex(x=>x.id===id);
      if(idx === -1) return;
      let allowedCategories = allCategories;
      if (currentUser && userCategoryPermissions[currentUser.email]) {
        allowedCategories = userCategoryPermissions[currentUser.email];
      }
      const missionCat = missions[idx].category;
      if (!allowedCategories.includes(missionCat)) {
        alert("××™×Ÿ ×œ×š ×”×¨×©××” ×œ××—×•×§ ××• ×œ××¨×›×‘ ××©×™××•×ª ×‘×§×˜×’×•×¨×™×” ×–×•");
        return;
      }
      if(missions[idx].status === "archived") {
        if(confirm("×œ××—×•×§ ×¡×•×¤×™×ª ××ª ×”××©×™××”?")) {
          db.collection('missions').doc(id).delete();
          missions = missions.filter(x=>x.id!==id);
        }
      } else {
        if(confirm("×œ×”×¢×‘×™×¨ ××©×™××” ×œ××¨×›×™×•×Ÿ?")) {
          missions[idx].status = "archived";
          saveMissions();
        }
      }
      filterMissions();
    };

    // -- Chat logic inside mission modal --
    let currentChatMissionId = null;
    function openMissionChat(id) {
      openMissionModal(id, true);
    }
    window.openMissionChat = openMissionChat;

    function renderChatMessages(chatArr=[]) {
      const chatMessages = document.getElementById('chatMessages');
      if (!chatMessages) return;
      chatMessages.innerHTML = chatArr.map(msg =>
        `<div class="mb-1 text-right">
          <span class="font-bold">${msg.user||'×× ×•× ×™××™'}:</span>
          <span>${msg.text}</span>
          <span class="text-xs text-gray-400 ltr ml-1">${msg.time}</span>
        </div>`
      ).join('');
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    function loadChatMessages(missionId) {
      currentChatMissionId = missionId;
      db.collection('missions').doc(missionId).collection('chat').orderBy('timestamp')
        .onSnapshot(snapshot => {
          const chatArr = snapshot.docs.map(doc => doc.data());
          renderChatMessages(chatArr);
        });
    }
    document.getElementById('chatForm').onsubmit = async function(e) {
      e.preventDefault();
      const text = document.getElementById('chatInput').value.trim();
      if(!text || !currentChatMissionId) return false;
      await db.collection('missions').doc(currentChatMissionId).collection('chat').add({
        text,
        user: currentUser ? (currentUser.email || "×× ×•× ×™××™") : "×× ×•× ×™××™",
        time: new Date().toLocaleTimeString('he-IL', {hour: '2-digit', minute: '2-digit'}),
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      document.getElementById('chatInput').value = '';
      return false;
    };

    // --- Export to Excel ---
    document.getElementById('exportExcelBtn').onclick = function() {
      const data = missions.map(m => ({
        ×›×•×ª×¨×ª: m.title,
        ×ª×™××•×¨: m.desc,
        ×§×˜×’×•×¨×™×”: m.category,
        ×¢×“×™×¤×•×ª: m.priority,
        ××©×•×™×š: m.assignee,
        ×¡×˜×˜×•×¡: m.status === 'archived' ? '×‘××¨×›×™×•×Ÿ' : (m.status === 'done' ? '×‘×•×¦×¢' : '×¤×¢×™×œ'),
        ×ª××¨×™×š: m.due
      }));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "××©×™××•×ª");
      XLSX.writeFile(wb, "××©×™××•×ª.xlsx");
    };

    // --- Export to PDF ---
    document.getElementById('exportPdfBtn').onclick = function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({orientation: "landscape"});
      let y = 15;
      doc.setFont("helvetica", "normal");
      doc.setFontSize(14);
      doc.text("×¨×©×™××ª ××©×™××•×ª", 140, y, {align:"center"});
      y += 10;
      doc.setFontSize(11);
      missions.forEach((m, i) => {
        doc.text(
          `${i+1}. ${m.title} | ${m.desc||""} | ×§×˜×’×•×¨×™×”: ${m.category||""} | ×¢×“×™×¤×•×ª: ${m.priority||""} | ×¡×˜×˜×•×¡: ${m.status==='archived'?'×‘××¨×›×™×•×Ÿ':m.status==='done'?'×‘×•×¦×¢':'×¤×¢×™×œ'} | ×ª××¨×™×š: ${m.due||""}`,
          10, y, {align:"right"}
        );
        y += 8;
        if (y > 190) { doc.addPage(); y = 15; }
      });
      doc.save("××©×™××•×ª.pdf");
    };

    // --- Listeners ---
    document.getElementById('searchInput').oninput = filterMissions;
    document.getElementById('priorityFilter').onchange = filterMissions;
    document.querySelectorAll('.cat-tab').forEach(btn=>{
      btn.onclick = ()=>{
        currentCategory = btn.dataset.cat;
        filterMissions();
      };
    });
    </script>
  </body>
</html>
