<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mission Tracker (Category Admins + Superadmin)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <meta name="robots" content="noindex" />
  <style>
    body {
      min-height: 100vh;
      background: linear-gradient(180deg, #e8eefe 0%, #ffffff 100%);
    }
    #missions:empty::after {
      content: "No missions yet. Click 'Add Mission' to begin.";
      display: block;
      color: #999;
      text-align: center;
      margin-top: 2rem;
      font-size: 1.125rem;
    }
    .admin-only { display: none; }
    .admin-visible { display: inline-block !important; }
    .feedback-list { max-height: 170px; overflow-y: auto; }
    .feedback-item { background: #f1f5f9; border-radius: 0.5rem; padding: 0.5rem; margin-bottom: 0.25rem; font-size:0.98em;}
    .modal-fade { transition: opacity 0.2s, transform 0.2s; }
    .rtl { direction: rtl; text-align: right; }
    .ltr { direction: ltr; text-align: left; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 flex flex-col items-center py-10 px-4">
  <div class="w-full max-w-2xl">

    <header class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-black tracking-tight text-blue-800">Mission Tracker</h1>
    </header>

    <!-- Auth Box -->
    <div id="authBox" class="bg-white p-6 rounded shadow max-w-md w-full mb-8">
      <h2 class="text-xl font-semibold mb-4">Sign in or Register</h2>
      <input id="authEmail" type="email" placeholder="Email" class="border p-2 w-full mb-2 rounded" autocomplete="username" />
      <input id="authPass" type="password" placeholder="Password" class="border p-2 w-full mb-2 rounded" autocomplete="current-password" />
      <div class="flex gap-2 mb-2">
        <button id="loginBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Login</button>
        <button id="registerBtn" class="bg-gray-600 text-white px-4 py-2 rounded">Register</button>
        <button id="logoutBtn" class="bg-red-600 text-white px-4 py-2 rounded hidden">Logout</button>
      </div>
      <div id="authStatus" class="text-sm text-gray-700 mt-3"></div>
    </div>

    <!-- Category Tabs -->
    <div id="categoryTabs" class="flex gap-2 mb-4">
      <button class="cat-tab px-4 py-2 rounded font-semibold" data-cat="all">All</button>
      <button class="cat-tab px-4 py-2 rounded font-semibold" data-cat="×ª×§×©×•×‘">×ª×§×©×•×‘</button>
      <button class="cat-tab px-4 py-2 rounded font-semibold" data-cat="×œ×•×’×™×¡×˜×™×§×”">×œ×•×’×™×¡×˜×™×§×”</button>
      <button class="cat-tab px-4 py-2 rounded font-semibold" data-cat="×¨×›×‘">×¨×›×‘</button>
      <button class="cat-tab px-4 py-2 rounded font-semibold" data-cat="×ž×˜×‘×—">×ž×˜×‘×—</button>
      <button class="cat-tab px-4 py-2 rounded font-semibold" data-cat="×ž×—× ×”">×ž×—× ×”</button>
    </div>

    <div class="flex flex-wrap items-center gap-3 mb-2">
      <button id="addBtn" class="bg-blue-600 hover:bg-blue-700 transition text-white px-5 py-2 rounded font-semibold shadow">Add Mission</button>
      <button id="exportExcelBtn" class="admin-only bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-semibold shadow">Export to Excel</button>
      <div class="ml-auto flex items-center gap-2">
        <span class="text-gray-500">User:</span>
        <span id="userEmailDisplay" class="font-semibold text-blue-700"></span>
        <span id="adminBadge" class="admin-only bg-blue-600 text-white px-2 py-1 rounded text-xs font-bold">Admin</span>
        <span id="superBadge" class="admin-only bg-red-600 text-white px-2 py-1 rounded text-xs font-bold">Superadmin</span>
      </div>
    </div>

    <div id="missions" class="mt-6 grid gap-5"></div>
  </div>

  <!-- Modal: Create / Edit Mission -->
  <div id="formModal" class="hidden fixed inset-0 bg-black/50 z-20 flex justify-center items-center">
    <div class="bg-white p-6 rounded shadow max-w-md w-full">
      <h2 class="text-xl font-semibold mb-4" id="formTitle">New Mission</h2>
      <select id="category" class="border p-2 w-full mb-2 rounded" required>
        <option value="">Select category</option>
        <option value="×ª×§×©×•×‘">×ª×§×©×•×‘</option>
        <option value="×œ×•×’×™×¡×˜×™×§×”">×œ×•×’×™×¡×˜×™×§×”</option>
        <option value="×¨×›×‘">×¨×›×‘</option>
        <option value="×ž×˜×‘×—">×ž×˜×‘×—</option>
        <option value="×ž×—× ×”">×ž×—× ×”</option>
      </select>
      <input id="title" placeholder="Title" class="border p-2 w-full mb-2 rounded" />
      <textarea id="description" placeholder="Description" class="border p-2 w-full mb-2 rounded"></textarea>
      <input id="deadline" type="date" class="border p-2 w-full mb-2 rounded" />
      <select id="status" class="border p-2 w-full mb-4 rounded">
        <option>Pending</option>
        <option>In Progress</option>
        <option>Complete</option>
      </select>
      <div class="flex justify-end gap-2">
        <button id="cancelBtn" class="px-4 py-2">Cancel</button>
        <button id="saveBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Save</button>
      </div>
    </div>
  </div>

  <!-- Modal: Feedback -->
  <div id="feedbackModal" class="hidden fixed inset-0 bg-black/30 z-30 flex justify-center items-center">
    <div class="modal-fade bg-white p-6 rounded shadow max-w-md w-full relative" style="min-width:320px;">
      <button id="closeFeedbackModal" class="absolute top-2 right-3 text-gray-400 hover:text-red-500 text-2xl font-bold">&times;</button>
      <h2 class="text-lg font-bold mb-2 text-blue-700">×ž×©×•×‘ ×œ×ž×©×™×ž×”</h2>
      <div class="feedback-list text-sm mb-3"></div>
      <div class="flex gap-1">
        <input class="feedback-input border p-2 rounded flex-1 transition-all" type="text" maxlength="300" placeholder="×”×•×¡×£ ×ž×©×•×‘..." autocomplete="off" />
        <button class="feedback-submit bg-blue-100 text-blue-800 px-4 rounded font-semibold">Send</button>
      </div>
    </div>
  </div>

  <template id="missionCardTpl">
    <div class="mission-card p-5 bg-white rounded shadow transition">
      <div class="flex items-start justify-between gap-4">
        <div class="min-w-0">
          <div class="flex gap-2 items-center mb-1">
            <span class="inline-block text-xs px-2 py-1 rounded bg-blue-50 text-blue-700 font-bold" data-field="category"></span>
            <h3 class="font-bold text-lg break-words whitespace-normal" data-field="title">Title</h3>
            <span class="status-badge inline-block px-2 py-1 rounded text-xs font-bold ml-2" data-field="status"></span>
          </div>
          <p class="mt-1" data-field="description">Descriptionâ€¦</p>
          <p class="mt-1 text-sm text-gray-500" data-field="meta">â€”</p>
        </div>
        <div class="flex-shrink-0 space-x-2">
          <button class="edit underline text-blue-600 hover:text-blue-900">Edit</button>
          <button class="delete underline text-red-600 hover:text-red-800 admin-only">Delete</button>
        </div>
      </div>
      <!-- Feedback Button -->
      <div class="mt-4 flex justify-end">
        <button class="open-feedback-btn bg-gray-100 hover:bg-blue-100 text-blue-800 px-3 py-1 rounded text-sm font-semibold transition">×ž×©×•×‘</button>
      </div>
    </div>
  </template>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import {
      getFirestore, collection, addDoc, doc, updateDoc, deleteDoc,
      onSnapshot, serverTimestamp, query, orderBy,
      getDocs, writeBatch, getDoc, setDoc
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyA7B7rovUIpikVGepAqQI2s3Y_xePEwkSA",
      authDomain: "missiontracker-52bb7.firebaseapp.com",
      projectId: "missiontracker-52bb7",
      storageBucket: "missiontracker-52bb7.appspot.com",
      messagingSenderId: "1029768338042",
      appId: "1:1029768338042:web:23b2a0539e0aab53daf9c3",
      measurementId: "G-TNVPW8RETF"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const authEmail = document.getElementById('authEmail');
    const authPass = document.getElementById('authPass');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const authStatus = document.getElementById('authStatus');
    const userEmailDisplay = document.getElementById('userEmailDisplay');
    const adminBadge = document.getElementById('adminBadge');
    const superBadge = document.getElementById('superBadge');
    const addBtn = document.getElementById('addBtn');
    const exportExcelBtn = document.getElementById('exportExcelBtn');

    let currentUser = null;
    let isAdmin = false;
    let isSuperAdmin = false;
    let allowedCategories = [];

    // Deadline formatting helpers
    function formatDeadline(dateStr) {
      if (!dateStr) return 'â€”';
      const date = new Date(dateStr);
      if (isNaN(date)) return dateStr;
      return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
    }
    function deadlineStatusClass(dateStr) {
      if (!dateStr) return 'text-gray-500';
      const now = new Date();
      const date = new Date(dateStr);
      const diff = (date - now) / (1000 * 60 * 60 * 24); // days
      if (diff < 0) return 'text-red-600 font-bold'; // overdue
      if (diff <= 3) return 'text-orange-600 font-semibold'; // soon
      return 'text-green-700 font-semibold';
    }

    async function checkIfAdmin(uid) {
      try {
        const docRef = doc(db, "admins", uid);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          const data = docSnap.data();
          allowedCategories = Array.isArray(data.categories) ? data.categories : [];
          isSuperAdmin = !!data.superadmin || (data.email === "admin@admins.com");
          isAdmin = true;
        } else {
          allowedCategories = [];
          isSuperAdmin = false;
          isAdmin = false;
        }
      } catch (e) {
        allowedCategories = [];
        isSuperAdmin = false;
        isAdmin = false;
      }
    }

    function updateAdminUI() {
      document.querySelectorAll('.admin-only').forEach(el => {
        el.classList.toggle("admin-visible", isAdmin);
      });
      adminBadge.classList.toggle("admin-visible", isAdmin && !isSuperAdmin);
      superBadge.classList.toggle("admin-visible", isSuperAdmin);
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        userEmailDisplay.textContent = user.email;
        logoutBtn.classList.remove("hidden");
        loginBtn.classList.add("hidden");
        registerBtn.classList.add("hidden");
        authEmail.classList.add("hidden");
        authPass.classList.add("hidden");
        addBtn.disabled = false;
        await checkIfAdmin(user.uid);
        updateAdminUI();
        if (isSuperAdmin) {
          authStatus.textContent = "Logged in as: " + user.email + " (Superadmin)";
        } else if (isAdmin) {
          authStatus.textContent = "Logged in as: " + user.email + " (Admin for: " + allowedCategories.join(", ") + ")";
        } else {
          authStatus.textContent = "Logged in as: " + user.email;
        }
      } else {
        currentUser = null;
        userEmailDisplay.textContent = "";
        logoutBtn.classList.add("hidden");
        loginBtn.classList.remove("hidden");
        registerBtn.classList.remove("hidden");
        authEmail.classList.remove("hidden");
        authPass.classList.remove("hidden");
        addBtn.disabled = true;
        authStatus.textContent = "Not logged in.";
        isAdmin = false;
        isSuperAdmin = false;
        allowedCategories = [];
        updateAdminUI();
      }
    });

    loginBtn.onclick = async () => {
      try {
        await signInWithEmailAndPassword(auth, authEmail.value, authPass.value);
        authStatus.textContent = "Logging in...";
      } catch (e) {
        authStatus.textContent = "Login failed: " + e.message;
      }
    };

    registerBtn.onclick = async () => {
      try {
        const cred = await createUserWithEmailAndPassword(auth, authEmail.value, authPass.value);
        await setDoc(doc(db, "users", cred.user.uid), {
          email: cred.user.email,
          createdAt: new Date()
        });
        authStatus.textContent = "Registered!";
      } catch (e) {
        authStatus.textContent = "Registration failed: " + e.message;
      }
    };

    logoutBtn.onclick = () => signOut(auth);

    const missionsEl = document.getElementById('missions');
    const modal = document.getElementById('formModal');
    const formTitle = document.getElementById('formTitle');
    const titleEl = document.getElementById('title');
    const descEl = document.getElementById('description');
    const deadlineEl = document.getElementById('deadline');
    const statusEl = document.getElementById('status');
    const cancelBtn = document.getElementById('cancelBtn');
    const categoryEl = document.getElementById('category');
    const categoryTabs = document.querySelectorAll('.cat-tab');

    // Feedback modal elements
    const feedbackModal = document.getElementById('feedbackModal');
    const closeFeedbackModal = document.getElementById('closeFeedbackModal');
    let feedbackListDiv = null;
    let feedbackInput = null;
    let feedbackSubmit = null;
    let activeMissionId = null;
    let feedbackUnsub = null;

    closeFeedbackModal.onclick = () => {
      feedbackModal.classList.add('hidden');
      activeMissionId = null;
      if (feedbackUnsub) feedbackUnsub();
    };

    window.addEventListener('keydown', (e) => {
      if (!feedbackModal.classList.contains('hidden') && e.key === "Escape") closeFeedbackModal.onclick();
    });

    let editingId = null;
    let missionsCache = [];
    let selectedCategory = "all";

    function updateCategoryHighlight() {
      categoryTabs.forEach(tab => {
        if (tab.dataset.cat === selectedCategory) {
          tab.classList.add('bg-blue-100', 'text-blue-800');
          tab.classList.remove('bg-gray-100', 'text-gray-700');
        } else {
          tab.classList.remove('bg-blue-100', 'text-blue-800');
          tab.classList.add('bg-gray-100', 'text-gray-700');
        }
      });
    }

    categoryTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        selectedCategory = tab.dataset.cat;
        updateCategoryHighlight();
        renderMissions();
      });
    });
    updateCategoryHighlight();

    function openForm(isEdit = false) {
      if (!currentUser) {
        alert("You must be logged in to add or edit missions.");
        return;
      }
      formTitle.textContent = isEdit ? 'Edit Mission' : 'New Mission';
      modal.classList.remove('hidden');
    }
    function closeForm() {
      modal.classList.add('hidden');
      editingId = null;
      titleEl.value = '';
      descEl.value = '';
      deadlineEl.value = '';
      statusEl.value = 'Pending';
      categoryEl.value = '';
    }

    cancelBtn.addEventListener('click', closeForm);
    addBtn.addEventListener('click', () => {
      if (!currentUser) {
        alert("Login first!");
        return;
      }
      openForm(false);
    });

    const missionsCol = collection(db, 'missions');

    document.getElementById('saveBtn').addEventListener('click', async () => {
      if (!currentUser) {
        alert("You must be logged in to save a mission.");
        return;
      }
      const payload = {
        title: titleEl.value.trim() || 'Untitled',
        description: descEl.value.trim(),
        deadline: deadlineEl.value || null,
        status: statusEl.value,
        updatedAt: serverTimestamp(),
        category: categoryEl.value || '',
        creator: currentUser.email || currentUser.uid
      };
      if (!payload.category) {
        alert("Please select a category.");
        return;
      }

      if (!(isSuperAdmin || (isAdmin && allowedCategories.includes(payload.category)))) {
        alert("You are not the admin for category: " + payload.category);
        return;
      }

      try {
        if (editingId) {
          await updateDoc(doc(db, 'missions', editingId), payload);
        } else {
          await addDoc(missionsCol, {
            ...payload,
            createdAt: serverTimestamp(),
          });
        }
        closeForm();
      } catch (e) {
        alert('Failed to save mission: ' + e.message);
      }
    });

    async function deleteMissionAndComments(id, category) {
      if (!(isSuperAdmin || (isAdmin && allowedCategories.includes(category)))) {
        alert("You are not the admin for category: " + category);
        return;
      }
      if (!confirm('Delete this mission and all its feedback?')) return;
      try {
        const missionRef = doc(db, 'missions', id);
        const commentsRef = collection(missionRef, 'comments');
        const commentsSnap = await getDocs(commentsRef);

        const batch = writeBatch(db);
        commentsSnap.forEach(c => batch.delete(c.ref));
        batch.delete(missionRef);
        await batch.commit();
      } catch (err) {
        alert('Delete failed: ' + (err?.message || err));
      }
    }

    // Feedback Modal with RTL/LTR detection
    function openFeedbackModal(missionId) {
      feedbackModal.classList.remove('hidden');
      activeMissionId = missionId;
      feedbackListDiv = feedbackModal.querySelector('.feedback-list');
      feedbackInput = feedbackModal.querySelector('.feedback-input');
      feedbackSubmit = feedbackModal.querySelector('.feedback-submit');
      feedbackInput.value = '';
      feedbackInput.classList.remove('rtl','ltr');
      feedbackInput.focus();

      // Real-time feedback list
      if (feedbackUnsub) feedbackUnsub();
      const commentsCol = collection(db, 'missions', missionId, 'comments');
      feedbackUnsub = onSnapshot(commentsCol, (snap) => {
        feedbackListDiv.innerHTML = '';
        const items = [];
        snap.forEach(doc => {
          const data = doc.data();
          // RTL/LTR per feedback
          const isHebrew = /[\u0590-\u05FF]/.test(data.text || "");
          const div = document.createElement('div');
          div.className = 'feedback-item ' + (isHebrew ? 'rtl' : 'ltr');
          div.innerHTML = `<b>${data.author || 'Anonymous'}:</b> ${data.text || ""}`;
          items.push(div);
        });
        items.reverse(); // Recent last
        items.forEach(div=>feedbackListDiv.appendChild(div));
        feedbackListDiv.scrollTop = feedbackListDiv.scrollHeight;
      });

      // RTL/LTR detection on input
      feedbackInput.oninput = () => {
        const val = feedbackInput.value;
        if (/[\u0590-\u05FF]/.test(val)) {
          feedbackInput.classList.add('rtl');
          feedbackInput.classList.remove('ltr');
        } else {
          feedbackInput.classList.remove('rtl');
          feedbackInput.classList.add('ltr');
        }
      };
      feedbackInput.oninput();

      // Enter to send
      feedbackInput.onkeydown = (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          feedbackSubmit.click();
        }
      };

      feedbackSubmit.onclick = async () => {
        if (!currentUser) {
          alert("Login to leave feedback.");
          return;
        }
        if (feedbackInput.value.trim() === '') return;
        await addDoc(commentsCol, {
          text: feedbackInput.value,
          author: currentUser ? currentUser.email : 'Anonymous',
          createdAt: serverTimestamp()
        });
        feedbackInput.value = '';
        feedbackInput.oninput();
      };
    }

    const qMissions = query(missionsCol, orderBy('createdAt', 'desc'));
    onSnapshot(qMissions, (snap) => {
      missionsCache = [];
      snap.forEach((docSnap) => {
        const m = docSnap.data();
        const id = docSnap.id;
        missionsCache.push({ ...m, id });
      });
      renderMissions();
    });

    function renderMissions() {
      missionsEl.innerHTML = '';
      const tpl = document.getElementById('missionCardTpl');
      let filtered = missionsCache;
      if (selectedCategory !== "all") {
        filtered = filtered.filter(m => m.category === selectedCategory);
      }
      filtered.forEach((m) => {
        const id = m.id;
        const card = tpl.content.cloneNode(true);
        const cardEl = card.children[0];

        cardEl.querySelector('[data-field="category"]').textContent = m.category || '';
        cardEl.querySelector('[data-field="title"]').textContent = m.title || 'Untitled';
        cardEl.querySelector('[data-field="description"]').textContent = m.description || '';

        // DEADLINE visually improved
        const meta = [];
        const deadlineFormatted = formatDeadline(m.deadline);
        const deadlineClass = deadlineStatusClass(m.deadline);
        meta.push(`<span class="${deadlineClass}">ðŸ“… ${deadlineFormatted}</span>`);
        meta.push('Created by: ' + (m.creator || 'â€”'));
        cardEl.querySelector('[data-field="meta"]').innerHTML = meta.join(' | ');

        // Status badge color
        const statusBadge = cardEl.querySelector('.status-badge');
        statusBadge.textContent = m.status || 'Pending';
        if (m.status === "Complete") {
          statusBadge.className = 'status-badge inline-block px-2 py-1 rounded text-xs font-bold ml-2 bg-green-200 text-green-900';
        } else if (m.status === "In Progress") {
          statusBadge.className = 'status-badge inline-block px-2 py-1 rounded text-xs font-bold ml-2 bg-yellow-200 text-yellow-900';
        } else { // Pending or anything else
          statusBadge.className = 'status-badge inline-block px-2 py-1 rounded text-xs font-bold ml-2 bg-gray-200 text-gray-900';
        }

        const editBtn = cardEl.querySelector('.edit');
        const canEdit = isSuperAdmin || (isAdmin && allowedCategories.includes(m.category));
        if (canEdit) {
          editBtn.style.display = '';
        } else {
          editBtn.style.display = 'none';
        }
        editBtn.addEventListener('click', () => {
          if (!currentUser) {
            alert("Login first!");
            return;
          }
          if (!canEdit) {
            alert("You are not the admin for category: " + m.category);
            return;
          }
          editingId = id;
          titleEl.value = m.title || '';
          descEl.value = m.description || '';
          deadlineEl.value = m.deadline || '';
          statusEl.value = m.status || 'Pending';
          categoryEl.value = m.category || '';
          openForm(true);
        });

        const deleteBtn = cardEl.querySelector('.delete');
        if (canEdit) {
          deleteBtn.classList.add("admin-visible");
        } else {
          deleteBtn.classList.remove("admin-visible");
        }
        deleteBtn.addEventListener('click', () => deleteMissionAndComments(id, m.category));

        // Feedback modal button
        cardEl.querySelector('.open-feedback-btn').onclick = () => openFeedbackModal(id);

        missionsEl.appendChild(card);
      });
    }
    addBtn.disabled = true;

    // EXPORT TO EXCEL WITH CURRENT DATE IN FILENAME
    exportExcelBtn.addEventListener('click', async () => {
      // Only admin/superadmin can export
      if (!isAdmin && !isSuperAdmin) {
        alert("Only admins can export!");
        return;
      }
      // Get all missions (filtered by selectedCategory if you want)
      let rows = [];
      for (const m of missionsCache) {
        if (selectedCategory !== "all" && m.category !== selectedCategory) continue;
        // Get all feedback for each mission
        let feedbackText = "";
        const commentsCol = collection(db, 'missions', m.id, 'comments');
        const commentsSnap = await getDocs(commentsCol);
        let feedbacks = [];
        commentsSnap.forEach(docSnap => {
          const d = docSnap.data();
          feedbacks.push(d.text ? d.text : "");
        });
        feedbackText = feedbacks.join("\n");
        // One row per mission
        rows.push({
          Category: m.category || '',
          Title: m.title || '',
          Description: m.description || '',
          Deadline: m.deadline || '',
          Status: m.status || '',
          Creator: m.creator || '',
          Feedback: feedbackText
        });
      }
      if (rows.length === 0) {
        alert("No missions to export.");
        return;
      }
      // Create worksheet & workbook
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Missions");

      // Add current date to filename
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      const dateStr = `${yyyy}-${mm}-${dd}`;
      XLSX.writeFile(wb, `missions_${dateStr}.xlsx`);
    });

  </script>
</body>
</html>
