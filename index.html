<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mission Tracker (Online • Firebase)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="robots" content="noindex" />
  <style>
    body { min-height: 100vh; }
    #missions:empty::after {
      content: "No missions yet. Click 'Add Mission' to begin.";
      display: block;
      color: #999;
      text-align: center;
      margin-top: 2rem;
      font-size: 1.125rem;
    }
    /* Subtle card hover */
    .mission-card:hover { box-shadow: 0 2px 14px 0 rgba(0,0,0,0.06);}
    /* Modal fade */
    #formModal:not(.hidden) { animation: fadeIn 0.15s;}
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 flex flex-col items-center py-10 px-4">
  <div class="w-full max-w-2xl">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-black tracking-tight text-blue-800">Mission Tracker</h1>
      <div id="userBadge" class="text-sm text-gray-600"></div>
    </header>

    <div class="flex flex-wrap items-center gap-3 mb-2">
      <button id="addBtn" class="bg-blue-600 hover:bg-blue-700 transition text-white px-5 py-2 rounded font-semibold shadow">Add Mission</button>
      <!-- Removed seed demo data button -->
      <div class="ml-auto flex items-center gap-2">
        <span class="text-gray-500">You are:</span>
        <span id="usernameDisplay" class="font-semibold text-blue-700"></span>
        <button id="changeNameBtn" class="text-xs text-blue-500 underline">Change</button>
      </div>
    </div>

    <div id="missions" class="mt-6 grid gap-5"></div>
  </div>

  <!-- Modal: Create / Edit Mission -->
  <div id="formModal" class="hidden fixed inset-0 bg-black/50 z-20 flex justify-center items-center">
    <div class="bg-white p-6 rounded shadow max-w-md w-full">
      <h2 class="text-xl font-semibold mb-4" id="formTitle">New Mission</h2>
      <input id="title" placeholder="Title" class="border p-2 w-full mb-2 rounded" />
      <textarea id="description" placeholder="Description" class="border p-2 w-full mb-2 rounded"></textarea>
      <input id="deadline" type="date" class="border p-2 w-full mb-2 rounded" />
      <select id="status" class="border p-2 w-full mb-4 rounded">
        <option>Pending</option>
        <option>In Progress</option>
        <option>Complete</option>
      </select>
      <div class="flex justify-end gap-2">
        <button id="cancelBtn" class="px-4 py-2">Cancel</button>
        <button id="saveBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Save</button>
      </div>
    </div>
  </div>

  <!-- Modal: Username -->
  <div id="usernameModal" class="hidden fixed inset-0 bg-black/50 z-30 flex justify-center items-center">
    <div class="bg-white p-7 rounded shadow max-w-xs w-full">
      <h2 class="text-lg font-semibold mb-4">Set your username</h2>
      <input id="usernameInput" maxlength="24" placeholder="Choose a username" class="border p-2 w-full mb-3 rounded" />
      <div class="text-xs text-gray-500 mb-4">This will be visible to others in comments. You can change it anytime.</div>
      <div class="flex justify-end gap-2">
        <button id="cancelNameBtn" class="px-3 py-2">Cancel</button>
        <button id="saveNameBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Save</button>
      </div>
    </div>
  </div>

  <template id="missionCardTpl">
    <div class="mission-card p-5 bg-white rounded shadow transition">
      <div class="flex items-start justify-between gap-4">
        <div class="min-w-0">
          <h3 class="font-bold text-lg truncate" data-field="title">Title</h3>
          <p class="mt-1" data-field="description">Description…</p>
          <p class="mt-1 text-sm text-gray-500" data-field="meta">—</p>
        </div>
        <div class="flex-shrink-0 space-x-2">
          <button class="edit underline text-blue-600 hover:text-blue-900">Edit</button>
          <button class="delete underline text-red-600 hover:text-red-800">Delete</button>
        </div>
      </div>
      <!-- Feedback / comments -->
      <div class="mt-4 border-t pt-3">
        <h4 class="font-semibold">Feedback</h4>
        <div class="space-y-2 mt-2" data-field="comments"></div>
        <form class="mt-3 flex gap-2" data-field="commentForm">
          <input required name="text" maxlength="500" placeholder="Add feedback…" class="border p-2 rounded flex-1" />
          <button class="bg-gray-800 hover:bg-black transition text-white px-3 py-2 rounded">Post</button>
        </form>
      </div>
    </div>
  </template>

  <script type="module">
    // --- Firebase SDK (v10) ---
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import {
      getFirestore, collection, addDoc, doc, updateDoc, deleteDoc,
      onSnapshot, serverTimestamp, query, orderBy,
      getDocs, writeBatch
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // --- Your Firebase project ---
    const firebaseConfig = {
      apiKey: "AIzaSyA7B7rovUIpikVGepAqQI2s3Y_xePEwkSA",
      authDomain: "missiontracker-52bb7.firebaseapp.com",
      projectId: "missiontracker-52bb7",
      storageBucket: "missiontracker-52bb7.appspot.com",
      messagingSenderId: "1029768338042",
      appId: "1:1029768338042:web:23b2a0539e0aab53daf9c3",
      measurementId: "G-TNVPW8RETF"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- Auth: sign in anonymously so each user has a uid for comments ---
    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, (user) => {
      const badge = document.getElementById('userBadge');
      if (user) {
        badge.textContent = `Signed in (anon) – ${user.uid.slice(0, 6)}…`;
      } else {
        badge.textContent = 'Not signed in';
      }
    });

    // --- Username (per IP) ---
    const usernameKey = "mt_username";
    const usernameDisplay = document.getElementById('usernameDisplay');
    const changeNameBtn = document.getElementById('changeNameBtn');
    const usernameModal = document.getElementById('usernameModal');
    const usernameInput = document.getElementById('usernameInput');
    const saveNameBtn = document.getElementById('saveNameBtn');
    const cancelNameBtn = document.getElementById('cancelNameBtn');

    let myUsername = null;

    // Get IP and suggest as default username (anonymous, not reliable for authentication)
    async function getIPUsernameSuggestion() {
      try {
        const res = await fetch('https://ipapi.co/json/');
        const data = await res.json();
        if (data && data.ip) {
          return "user-" + data.ip.replace(/\./g, "-");
        }
      } catch (e) {}
      return "user-" + Math.floor(Math.random() * 90000 + 10000);
    }

    function showUsernameModal(initial = "") {
      usernameInput.value = initial;
      usernameModal.classList.remove('hidden');
      usernameInput.focus();
    }

    function hideUsernameModal() {
      usernameModal.classList.add('hidden');
    }

    function setUsername(name) {
      myUsername = name.trim().slice(0,24) || "anon";
      localStorage.setItem(usernameKey, myUsername);
      usernameDisplay.textContent = myUsername;
    }

    // Initial username setup
    async function ensureUsername() {
      let name = localStorage.getItem(usernameKey);
      if (!name) {
        // Suggest IP-based
        name = await getIPUsernameSuggestion();
        showUsernameModal(name);
      } else {
        setUsername(name);
      }
    }
    // Username modal logic
   saveNameBtn.onclick = () => {
  // Allow Hebrew, English, numbers, underscore, hyphen, space
  const val = usernameInput.value.trim().replace(/[^\u0590-\u05FFa-zA-Z0-9_\- ]/g, '').slice(0,24);
  if (val.length < 2) {
    alert("Username must be at least 2 characters.");
    return;
  }
  setUsername(val);
  hideUsernameModal();
};
    cancelNameBtn.onclick = () => {
      if (!localStorage.getItem(usernameKey)) {
        alert("You must set a username to use the site.");
        return;
      }
      hideUsernameModal();
    };
    changeNameBtn.onclick = () => {
      showUsernameModal(myUsername || "");
    };

    // Run on load
    await ensureUsername();

    // --- UI refs ---
    const missionsEl = document.getElementById('missions');
    const modal = document.getElementById('formModal');
    const formTitle = document.getElementById('formTitle');
    const titleEl = document.getElementById('title');
    const descEl = document.getElementById('description');
    const deadlineEl = document.getElementById('deadline');
    const statusEl = document.getElementById('status');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const addBtn = document.getElementById('addBtn');
    // Removed seedBtn

    let editingId = null; // Firestore doc id when editing

    function openForm(isEdit = false) {
      formTitle.textContent = isEdit ? 'Edit Mission' : 'New Mission';
      modal.classList.remove('hidden');
    }
    function closeForm() {
      modal.classList.add('hidden');
      editingId = null;
      titleEl.value = '';
      descEl.value = '';
      deadlineEl.value = '';
      statusEl.value = 'Pending';
    }

    cancelBtn.addEventListener('click', closeForm);
    addBtn.addEventListener('click', () => openForm(false));

    // --- Firestore collections ---
    const missionsCol = collection(db, 'missions');

    // Create or update mission
    saveBtn.addEventListener('click', async () => {
      const payload = {
        title: titleEl.value.trim() || 'Untitled',
        description: descEl.value.trim(),
        deadline: deadlineEl.value || null,
        status: statusEl.value,
        updatedAt: serverTimestamp(),
      };
      try {
        if (editingId) {
          await updateDoc(doc(db, 'missions', editingId), payload);
        } else {
          await addDoc(missionsCol, {
            ...payload,
            createdAt: serverTimestamp(),
          });
        }
        closeForm();
      } catch (e) {
        alert('Failed to save mission: ' + e.message);
      }
    });

    // Removed seed demo data event listener

    // Render helper
    function el(tag, attrs = {}, children = []) {
      const n = document.createElement(tag);
      Object.entries(attrs).forEach(([k, v]) => {
        if (k === 'class') n.className = v;
        else if (k.startsWith('on')) n.addEventListener(k.slice(2), v);
        else n.setAttribute(k, v);
      });
      children.forEach(c => n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c));
      return n;
    }

    // Delete mission + all comments (batched)
    async function deleteMissionAndComments(id) {
      if (!confirm('Delete this mission and all its feedback?')) return;
      try {
        const missionRef = doc(db, 'missions', id);
        const commentsRef = collection(missionRef, 'comments');
        const commentsSnap = await getDocs(commentsRef);

        const batch = writeBatch(db);
        commentsSnap.forEach(c => batch.delete(c.ref));
        batch.delete(missionRef);
        await batch.commit();
      } catch (err) {
        console.error('Failed to delete mission/comments:', err);
        alert('Delete failed: ' + (err?.message || err));
      }
    }

    // Subscribe to missions in real-time
    const qMissions = query(missionsCol, orderBy('createdAt', 'desc'));
    onSnapshot(qMissions, (snap) => {
      missionsEl.innerHTML = '';
      const tpl = document.getElementById('missionCardTpl');
      snap.forEach((docSnap) => {
        const m = docSnap.data();
        const id = docSnap.id;
        const card = tpl.content.cloneNode(true);

        card.querySelector('[data-field="title"]').textContent = m.title || 'Untitled';
        card.querySelector('[data-field="description"]').textContent = m.description || '';
        const meta = [];
        meta.push('Status: ' + (m.status || 'Pending'));
        meta.push('Deadline: ' + (m.deadline || '—'));
        card.querySelector('[data-field="meta"]').textContent = meta.join(' | ');

        // Edit
        card.querySelector('.edit').addEventListener('click', () => {
          editingId = id;
          titleEl.value = m.title || '';
          descEl.value = m.description || '';
          deadlineEl.value = m.deadline || '';
          statusEl.value = m.status || 'Pending';
          openForm(true);
        });
        // Delete (mission + comments)
        card.querySelector('.delete').addEventListener('click', () => deleteMissionAndComments(id));

        // Comments live list
        const commentsWrap = card.querySelector('[data-field="comments"]');
        const qComments = query(collection(db, 'missions', id, 'comments'), orderBy('createdAt', 'asc'));
        onSnapshot(qComments, (csnap) => {
          commentsWrap.innerHTML = '';
          csnap.forEach((c) => {
            const d = c.data();
            const item = el('div', { class: 'text-sm' }, [
              el('div', { class: 'flex items-baseline gap-2' }, [
                el('span', { class: 'font-medium text-blue-700' }, [d.authorName || 'anon']),
                el('span', { class: 'text-gray-500' }, [new Date(d.createdAt?.toDate?.() || Date.now()).toLocaleString()])
              ]),
              el('div', {}, [d.text || ''])
            ]);
            commentsWrap.appendChild(item);
          });
        });

        // Comment form
        const form = card.querySelector('[data-field="commentForm"]');
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const data = new FormData(form);
          const text = (data.get('text') || '').toString().trim();
          if (!text) return;
          try {
            await addDoc(collection(db, 'missions', id, 'comments'), {
              text,
              author: auth.currentUser?.uid || 'anon',
              authorName: myUsername || "anon",
              createdAt: serverTimestamp(),
            });
            form.reset();
          } catch (e2) { alert('Failed to post: ' + (e2?.message || e2)); }
        });

        missionsEl.appendChild(card);
      });
    });
  </script>
</body>
</html>
