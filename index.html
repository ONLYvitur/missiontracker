<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mission Tracker (Online)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800 p-6">
  <header class="flex items-center justify-between">
    <h1 class="text-2xl font-bold">Mission Tracker</h1>
    <div class="flex items-center gap-3">
      <span id="connDot" class="inline-block w-2.5 h-2.5 rounded-full bg-gray-300"></span>
      <span id="connText" class="text-sm text-gray-500">Connecting…</span>
    </div>
  </header>

  <div class="mt-4 flex gap-2">
    <button onclick="openForm()" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700">Add Mission</button>
  </div>

  <div id="missions" class="mt-4 grid gap-4"></div>

  <!-- Modal -->
  <div id="formModal" class="hidden fixed inset-0 bg-black/50 flex justify-center items-center p-4">
    <div class="bg-white p-6 rounded-2xl shadow max-w-md w-full">
      <h2 class="text-xl font-semibold mb-4" id="formTitle">New Mission</h2>
      <div class="space-y-3">
        <input id="title" placeholder="Title" class="border p-2 w-full rounded" />
        <textarea id="description" placeholder="Description" class="border p-2 w-full rounded"></textarea>
        <input id="deadline" type="date" class="border p-2 w-full rounded" />
        <select id="status" class="border p-2 w-full rounded">
          <option>Pending</option>
          <option>In Progress</option>
          <option>Complete</option>
        </select>
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button onclick="closeForm()" class="px-4 py-2">Cancel</button>
        <button id="saveBtn" onclick="saveMission()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Save</button>
      </div>
    </div>
  </div>

  <template id="cardTpl">
    <div class="p-4 bg-white rounded-2xl shadow border border-gray-100">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h3 class="font-semibold text-lg card-title"></h3>
          <p class="text-gray-700 whitespace-pre-wrap card-desc"></p>
        </div>
        <span class="text-xs px-2 py-1 rounded-full card-status"></span>
      </div>
      <p class="text-sm text-gray-500 mt-2 card-deadline"></p>
      <div class="mt-3 flex gap-3">
        <button class="underline text-blue-600" data-action="edit">Edit</button>
        <button class="underline text-red-600" data-action="delete">Delete</button>
      </div>
    </div>
  </template>

  <script type="module">
    // --- 1) Firebase setup ----------------------------------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { 
      getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, 
      serverTimestamp, onSnapshot, query, orderBy, enableIndexedDbPersistence 
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // TODO: Replace with your Firebase project config (Project Settings → General → SDK setup & config → CDN)
    const firebaseConfig = {
  apiKey: "AIzaSyA7B7rovUIpikVGepAqQI2s3Y_xePEwkSA",
  authDomain: "missiontracker-52bb7.firebaseapp.com",
  projectId: "missiontracker-52bb7",
  storageBucket: "missiontracker-52bb7.firebasestorage.app",
  messagingSenderId: "1029768338042",
  appId: "1:1029768338042:web:23b2a0539e0aab53daf9c3",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Enable offline cache so app works without internet; syncs when back online
    enableIndexedDbPersistence(db).catch(() => {/* ignore if multiple tabs */});

    // Anonymous auth lets Firestore rules restrict write access if needed
    signInAnonymously(auth).catch(console.error);

    // --- 2) DOM helpers -------------------------------------------------------
    const missionsEl = document.getElementById('missions');
    const formModal = document.getElementById('formModal');
    const titleEl = document.getElementById('title');
    const descEl = document.getElementById('description');
    const deadlineEl = document.getElementById('deadline');
    const statusEl = document.getElementById('status');
    const formTitleEl = document.getElementById('formTitle');
    const saveBtn = document.getElementById('saveBtn');

    const connDot = document.getElementById('connDot');
    const connText = document.getElementById('connText');

    let editDocId = null;

    function setConn(online) {
      connDot.className = `inline-block w-2.5 h-2.5 rounded-full ${online ? 'bg-green-500' : 'bg-gray-300'}`;
      connText.textContent = online ? 'Online' : 'Offline';
    }
    window.addEventListener('online', () => setConn(true));
    window.addEventListener('offline', () => setConn(false));
    setConn(navigator.onLine);

    function openForm() {
      formModal.classList.remove('hidden');
    }
    window.openForm = openForm;

    function closeForm() {
      formModal.classList.add('hidden');
      titleEl.value = '';
      descEl.value = '';
      deadlineEl.value = '';
      statusEl.value = 'Pending';
      editDocId = null;
      formTitleEl.textContent = 'New Mission';
      saveBtn.textContent = 'Save';
    }
    window.closeForm = closeForm;

    function renderMissions(list) {
      missionsEl.innerHTML = '';
      const tpl = document.getElementById('cardTpl');
      list.forEach((m) => {
        const node = tpl.content.cloneNode(true);
        node.querySelector('.card-title').textContent = m.title;
        node.querySelector('.card-desc').textContent = m.description || '';
        node.querySelector('.card-deadline').textContent = m.deadline ? `Deadline: ${m.deadline}` : 'No deadline';
        const statusPill = node.querySelector('.card-status');
        statusPill.textContent = m.status;
        statusPill.classList.add(
          m.status === 'Complete' ? 'bg-green-100 text-green-700' :
          m.status === 'In Progress' ? 'bg-amber-100 text-amber-700' :
          'bg-gray-100 text-gray-700'
        );

        const card = node.querySelector('div');
        card.querySelector('[data-action="edit"]').addEventListener('click', () => editMission(m));
        card.querySelector('[data-action="delete"]').addEventListener('click', () => deleteMission(m));
        missionsEl.appendChild(node);
      });
    }

    // --- 3) Firestore: live sync ---------------------------------------------
    let unsubscribe = null;

    onAuthStateChanged(auth, (user) => {
      if (!user) return;
      // You can scope by user.uid if you want separate boards per user. For shared board across devices, we just use a single collection.
      const q = query(collection(db, 'missions'), orderBy('createdAt', 'asc'));
      unsubscribe?.();
      unsubscribe = onSnapshot(q, (snap) => {
        const items = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
        renderMissions(items);
        setConn(true); // if we get snapshots, we have a connection (or cache)
      }, (err) => {
        console.error(err);
      });
    });

    async function saveMission() {
      const m = {
        title: titleEl.value.trim(),
        description: descEl.value.trim(),
        deadline: deadlineEl.value || null,
        status: statusEl.value,
        updatedAt: serverTimestamp(),
      };
      if (!m.title) { alert('Please enter a title'); return; }
      try {
        if (editDocId) {
          await updateDoc(doc(db, 'missions', editDocId), m);
        } else {
          await addDoc(collection(db, 'missions'), { ...m, createdAt: serverTimestamp() });
        }
        closeForm();
      } catch (e) {
        console.error(e);
        alert('Failed to save. Check your internet or Firebase rules.');
      }
    }
    window.saveMission = saveMission;

    function editMission(m) {
      editDocId = m.id;
      titleEl.value = m.title || '';
      descEl.value = m.description || '';
      deadlineEl.value = m.deadline || '';
      statusEl.value = m.status || 'Pending';
      formTitleEl.textContent = 'Edit Mission';
      saveBtn.textContent = 'Update';
      openForm();
    }

    async function deleteMission(m) {
      if (!confirm('Delete this mission?')) return;
      try {
        await deleteDoc(doc(db, 'missions', m.id));
      } catch (e) {
        console.error(e);
        alert('Failed to delete.');
      }
    }

    // Expose for inline handlers bound when rendering
    window.editMission = editMission;
    window.deleteMission = deleteMission;
  </script>

  <footer class="mt-10 text-xs text-gray-400">
    <p>Tip: This version uses Firebase Firestore for real-time sync across devices. Replace the Firebase config with your own. Data may be readable/writeable by anyone with this link if your rules are open—configure security rules accordingly.</p>
  </footer>
</body>
</html>

