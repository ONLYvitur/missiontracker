<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mission Tracker (Category Admins Example)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="robots" content="noindex" />
  <style>
    body {
      min-height: 100vh;
      background:
        linear-gradient(180deg, #e8eefe 0%, #ffffff 100%),
        url('img/emblem.png') center 120px no-repeat;
      background-size: cover, 320px auto;
    }
    #missions:empty::after {
      content: "No missions yet. Click 'Add Mission' to begin.";
      display: block;
      color: #999;
      text-align: center;
      margin-top: 2rem;
      font-size: 1.125rem;
    }
    .mission-card:hover { box-shadow: 0 2px 14px 0 rgba(0,0,0,0.06);}
    #formModal:not(.hidden) { animation: fadeIn 0.15s;}
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .admin-only { display: none; }
    .admin-visible { display: inline-block !important; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 flex flex-col items-center py-10 px-4">
  <div class="w-full max-w-2xl">

    <header class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-black tracking-tight text-blue-800">Mission Tracker</h1>
    </header>

    <!-- Auth Box -->
    <div id="authBox" class="bg-white p-6 rounded shadow max-w-md w-full mb-8">
      <h2 class="text-xl font-semibold mb-4">Sign in or Register</h2>
      <input id="authEmail" type="email" placeholder="Email" class="border p-2 w-full mb-2 rounded" autocomplete="username" />
      <input id="authPass" type="password" placeholder="Password" class="border p-2 w-full mb-2 rounded" autocomplete="current-password" />
      <div class="flex gap-2 mb-2">
        <button id="loginBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Login</button>
        <button id="registerBtn" class="bg-gray-600 text-white px-4 py-2 rounded">Register</button>
        <button id="logoutBtn" class="bg-red-600 text-white px-4 py-2 rounded hidden">Logout</button>
      </div>
      <div id="authStatus" class="text-sm text-gray-700 mt-3"></div>
    </div>

    <!-- Category Tabs -->
    <div id="categoryTabs" class="flex gap-2 mb-4">
      <button class="cat-tab px-4 py-2 rounded font-semibold bg-blue-100 text-blue-800" data-cat="all">All</button>
      <button class="cat-tab px-4 py-2 rounded font-semibold bg-gray-100 text-gray-700" data-cat="תקשוב">תקשוב</button>
      <button class="cat-tab px-4 py-2 rounded font-semibold bg-gray-100 text-gray-700" data-cat="לוגסטיקה">לוגסטיקה</button>
      <button class="cat-tab px-4 py-2 rounded font-semibold bg-gray-100 text-gray-700" data-cat="רכב">רכב</button>
      <button class="cat-tab px-4 py-2 rounded font-semibold bg-gray-100 text-gray-700" data-cat="מטבח">מטבח</button>
      <button class="cat-tab px-4 py-2 rounded font-semibold bg-gray-100 text-gray-700" data-cat="מחנה">מחנה</button>
    </div>

    <div class="flex flex-wrap items-center gap-3 mb-2">
      <button id="addBtn" class="bg-blue-600 hover:bg-blue-700 transition text-white px-5 py-2 rounded font-semibold shadow">Add Mission</button>
      <div class="ml-auto flex items-center gap-2">
        <span class="text-gray-500">User:</span>
        <span id="userEmailDisplay" class="font-semibold text-blue-700"></span>
        <span id="adminBadge" class="admin-only bg-blue-600 text-white px-2 py-1 rounded text-xs font-bold">Admin</span>
      </div>
    </div>

    <div id="missions" class="mt-6 grid gap-5"></div>
  </div>

  <!-- Modal: Create / Edit Mission -->
  <div id="formModal" class="hidden fixed inset-0 bg-black/50 z-20 flex justify-center items-center">
    <div class="bg-white p-6 rounded shadow max-w-md w-full">
      <h2 class="text-xl font-semibold mb-4" id="formTitle">New Mission</h2>
      <select id="category" class="border p-2 w-full mb-2 rounded" required>
        <option value="">Select category</option>
        <option value="תקשוב">תקשוב</option>
        <option value="לוגסטיקה">לוגסטיקה</option>
        <option value="רכב">רכב</option>
        <option value="מטבח">מטבח</option>
        <option value="מחנה">מחנה</option>
      </select>
      <input id="title" placeholder="Title" class="border p-2 w-full mb-2 rounded" />
      <textarea id="description" placeholder="Description" class="border p-2 w-full mb-2 rounded"></textarea>
      <input id="deadline" type="date" class="border p-2 w-full mb-2 rounded" />
      <select id="status" class="border p-2 w-full mb-4 rounded">
        <option>Pending</option>
        <option>In Progress</option>
        <option>Complete</option>
      </select>
      <div class="flex justify-end gap-2">
        <button id="cancelBtn" class="px-4 py-2">Cancel</button>
        <button id="saveBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Save</button>
      </div>
    </div>
  </div>

  <template id="missionCardTpl">
    <div class="mission-card p-5 bg-white rounded shadow transition">
      <div class="flex items-start justify-between gap-4">
        <div class="min-w-0">
          <div class="flex gap-2 items-center mb-1">
            <span class="inline-block text-xs px-2 py-1 rounded bg-blue-50 text-blue-700 font-bold" data-field="category"></span>
            <h3 class="font-bold text-lg truncate" data-field="title">Title</h3>
          </div>
          <p class="mt-1" data-field="description">Description…</p>
          <p class="mt-1 text-sm text-gray-500" data-field="meta">—</p>
        </div>
        <div class="flex-shrink-0 space-x-2">
          <button class="edit underline text-blue-600 hover:text-blue-900">Edit</button>
          <button class="delete underline text-red-600 hover:text-red-800 admin-only">Delete</button>
        </div>
      </div>
      <!-- Feedback / comments -->
      <div class="mt-4 border-t pt-3">
        <h4 class="font-semibold">Feedback</h4>
        <div class="space-y-2 mt-2" data-field="comments"></div>
        <form class="mt-3 flex gap-2" data-field="commentForm">
          <input required name="text" maxlength="500" placeholder="Add feedback…" class="border p-2 rounded flex-1" />
          <button class="bg-gray-800 hover:bg-black transition text-white px-3 py-2 rounded">Post</button>
        </form>
      </div>
    </div>
  </template>

  <script type="module">
    // --- Firebase SDK (v10) ---
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import {
      getFirestore, collection, addDoc, doc, updateDoc, deleteDoc,
      onSnapshot, serverTimestamp, query, orderBy,
      getDocs, writeBatch, getDoc, setDoc
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // --- Your Firebase project ---
    const firebaseConfig = {
      apiKey: "AIzaSyA7B7rovUIpikVGepAqQI2s3Y_xePEwkSA",
      authDomain: "missiontracker-52bb7.firebaseapp.com",
      projectId: "missiontracker-52bb7",
      storageBucket: "missiontracker-52bb7.appspot.com",
      messagingSenderId: "1029768338042",
      appId: "1:1029768338042:web:23b2a0539e0aab53daf9c3",
      measurementId: "G-TNVPW8RETF"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- Auth UI and Logic ---
    const authEmail = document.getElementById('authEmail');
    const authPass = document.getElementById('authPass');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const authStatus = document.getElementById('authStatus');
    const userEmailDisplay = document.getElementById('userEmailDisplay');
    const adminBadge = document.getElementById('adminBadge');
    const addBtn = document.getElementById('addBtn');

    let currentUser = null;
    let isAdmin = false;
    let allowedCategories = [];

    // Check if user is admin (admins collection: admins/{uid} exists)
    async function checkIfAdmin(uid) {
      try {
        const docRef = doc(db, "admins", uid);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          const data = docSnap.data();
          allowedCategories = Array.isArray(data.categories) ? data.categories : [];
          return true;
        }
        allowedCategories = [];
        return false;
      } catch (e) {
        allowedCategories = [];
        return false;
      }
    }

    function updateAdminUI() {
      document.querySelectorAll('.admin-only').forEach(el => {
        el.classList.toggle("admin-visible", isAdmin);
      });
      adminBadge.classList.toggle("admin-visible", isAdmin);
    }

    // Auth state listener
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        userEmailDisplay.textContent = user.email;
        logoutBtn.classList.remove("hidden");
        loginBtn.classList.add("hidden");
        registerBtn.classList.add("hidden");
        authEmail.classList.add("hidden");
        authPass.classList.add("hidden");
        addBtn.disabled = false;
        isAdmin = await checkIfAdmin(user.uid);
        if (isAdmin) {
          authStatus.textContent = "Logged in as: " + user.email + " (Admin for: " + allowedCategories.join(", ") + ")";
        } else {
          authStatus.textContent = "Logged in as: " + user.email;
        }
        updateAdminUI();
      } else {
        currentUser = null;
        userEmailDisplay.textContent = "";
        logoutBtn.classList.add("hidden");
        loginBtn.classList.remove("hidden");
        registerBtn.classList.remove("hidden");
        authEmail.classList.remove("hidden");
        authPass.classList.remove("hidden");
        addBtn.disabled = true;
        authStatus.textContent = "Not logged in.";
        isAdmin = false;
        allowedCategories = [];
        updateAdminUI();
      }
    });

    // Login
    loginBtn.onclick = async () => {
      try {
        await signInWithEmailAndPassword(auth, authEmail.value, authPass.value);
        authStatus.textContent = "Logging in...";
      } catch (e) {
        authStatus.textContent = "Login failed: " + e.message;
      }
    };

    // Register (only allow emails in this array)
    const allowedRegisterEmails = [
      "admin@mission.com",
      "admin2@mission.com",
      "example@mission.com"
    ];
    registerBtn.onclick = async () => {
      const email = authEmail.value.trim().toLowerCase();
      if (!allowedRegisterEmails.includes(email)) {
        authStatus.textContent = "Registration is only allowed for: " + allowedRegisterEmails.join(", ");
        return;
      }
      try {
        const cred = await createUserWithEmailAndPassword(auth, authEmail.value, authPass.value);
        // Optionally: Add user to Firestore users collection
        await setDoc(doc(db, "users", cred.user.uid), {
          email: cred.user.email,
          createdAt: new Date()
        });
        authStatus.textContent = "Registered!";
      } catch (e) {
        authStatus.textContent = "Registration failed: " + e.message;
      }
    };

    // Logout
    logoutBtn.onclick = () => signOut(auth);

    // --- UI refs ---
    const missionsEl = document.getElementById('missions');
    const modal = document.getElementById('formModal');
    const formTitle = document.getElementById('formTitle');
    const titleEl = document.getElementById('title');
    const descEl = document.getElementById('description');
    const deadlineEl = document.getElementById('deadline');
    const statusEl = document.getElementById('status');
    const cancelBtn = document.getElementById('cancelBtn');
    const categoryEl = document.getElementById('category');
    const categoryTabs = document.querySelectorAll('.cat-tab');

    let editingId = null; // Firestore doc id when editing
    let missionsCache = [];
    let selectedCategory = "all";

    // Category filter
    categoryTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        categoryTabs.forEach(t => t.classList.remove('bg-blue-100', 'text-blue-800'));
        tab.classList.add('bg-blue-100', 'text-blue-800');
        selectedCategory = tab.dataset.cat;
        renderMissions();
      });
    });

    function openForm(isEdit = false) {
      if (!currentUser) {
        alert("You must be logged in to add or edit missions.");
        return;
      }
      formTitle.textContent = isEdit ? 'Edit Mission' : 'New Mission';
      modal.classList.remove('hidden');
    }
    function closeForm() {
      modal.classList.add('hidden');
      editingId = null;
      titleEl.value = '';
      descEl.value = '';
      deadlineEl.value = '';
      statusEl.value = 'Pending';
      categoryEl.value = '';
    }

    cancelBtn.addEventListener('click', closeForm);
    addBtn.addEventListener('click', () => {
      if (!currentUser) {
        alert("Login first!");
        return;
      }
      openForm(false);
    });

    // --- Firestore collections ---
    const missionsCol = collection(db, 'missions');

    // Create or update mission
    document.getElementById('saveBtn').addEventListener('click', async () => {
      if (!currentUser) {
        alert("You must be logged in to save a mission.");
        return;
      }
      const payload = {
        title: titleEl.value.trim() || 'Untitled',
        description: descEl.value.trim(),
        deadline: deadlineEl.value || null,
        status: statusEl.value,
        updatedAt: serverTimestamp(),
        category: categoryEl.value || '',
        creator: currentUser.email || currentUser.uid
      };
      if (!payload.category) {
        alert("Please select a category.");
        return;
      }

      // Only allow add/edit if admin for that category
      if (!allowedCategories.includes(payload.category)) {
        alert("You are not the admin for category: " + payload.category);
        return;
      }

      try {
        if (editingId) {
          await updateDoc(doc(db, 'missions', editingId), payload);
        } else {
          await addDoc(missionsCol, {
            ...payload,
            createdAt: serverTimestamp(),
          });
        }
        closeForm();
      } catch (e) {
        alert('Failed to save mission: ' + e.message);
      }
    });

    // Render helper
    function el(tag, attrs = {}, children = []) {
      const n = document.createElement(tag);
      Object.entries(attrs).forEach(([k, v]) => {
        if (k === 'class') n.className = v;
        else if (k.startsWith('on')) n.addEventListener(k.slice(2), v);
        else n.setAttribute(k, v);
      });
      children.forEach(c => n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c));
      return n;
    }

    // Delete mission + all comments (batched) -- only admins for that category
    async function deleteMissionAndComments(id, category) {
      if (!isAdmin || !allowedCategories.includes(category)) {
        alert("You are not the admin for category: " + category);
        return;
      }
      if (!confirm('Delete this mission and all its feedback?')) return;
      try {
        const missionRef = doc(db, 'missions', id);
        const commentsRef = collection(missionRef, 'comments');
        const commentsSnap = await getDocs(commentsRef);

        const batch = writeBatch(db);
        commentsSnap.forEach(c => batch.delete(c.ref));
        batch.delete(missionRef);
        await batch.commit();
      } catch (err) {
        alert('Delete failed: ' + (err?.message || err));
      }
    }

    // Subscribe to missions in real-time
    const qMissions = query(missionsCol, orderBy('createdAt', 'desc'));
    onSnapshot(qMissions, (snap) => {
      missionsCache = [];
      snap.forEach((docSnap) => {
        const m = docSnap.data();
        const id = docSnap.id;
        missionsCache.push({ ...m, id });
      });
      renderMissions();
    });

    function renderMissions() {
      missionsEl.innerHTML = '';
      const tpl = document.getElementById('missionCardTpl');
      let filtered = missionsCache;
      if (selectedCategory !== "all") {
        filtered = filtered.filter(m => m.category === selectedCategory);
      }
      filtered.forEach((m) => {
        const id = m.id;
        const card = tpl.content.cloneNode(true);

        card.querySelector('[data-field="category"]').textContent = m.category || '';
        card.querySelector('[data-field="title"]').textContent = m.title || 'Untitled';
        card.querySelector('[data-field="description"]').textContent = m.description || '';
        const meta = [];
        meta.push('Status: ' + (m.status || 'Pending'));
        meta.push('Deadline: ' + (m.deadline || '—'));
        meta.push('Created by: ' + (m.creator || '—'));
        card.querySelector('[data-field="meta"]').textContent = meta.join(' | ');

        // Edit
        const editBtn = card.querySelector('.edit');
        const canEdit = isAdmin && allowedCategories.includes(m.category);
        if (canEdit) {
          editBtn.style.display = '';
        } else {
          editBtn.style.display = 'none';
        }
        editBtn.addEventListener('click', () => {
          if (!currentUser) {
            alert("Login first!");
            return;
          }
          if (!canEdit) {
            alert("You are not the admin for category: " + m.category);
            return;
          }
          editingId = id;
          titleEl.value = m.title || '';
          descEl.value = m.description || '';
          deadlineEl.value = m.deadline || '';
          statusEl.value = m.status || 'Pending';
          categoryEl.value = m.category || '';
          openForm(true);
        });

        // Delete (mission + comments) -- only admins for that category
        const deleteBtn = card.querySelector('.delete');
        if (canEdit) {
          deleteBtn.classList.add("admin-visible");
        } else {
          deleteBtn.classList.remove("admin-visible");
        }
        deleteBtn.addEventListener('click', () => deleteMissionAndComments(id, m.category));

        // Comments live list
        const commentsWrap = card.querySelector('[data-field="comments"]');
        const qComments = query(collection(db, 'missions', id, 'comments'), orderBy('createdAt', 'asc'));
        onSnapshot(qComments, (csnap) => {
          commentsWrap.innerHTML = '';
          csnap.forEach((c) => {
            const d = c.data();
            const item = el('div', { class: 'text-sm' }, [
              el('div', { class: 'flex items-baseline gap-2' }, [
                el('span', { class: 'font-medium text-blue-700' }, [d.authorName || d.author || 'anon']),
                el('span', { class: 'text-gray-500' }, [new Date(d.createdAt?.toDate?.() || Date.now()).toLocaleString()])
              ]),
              el('div', {}, [d.text || ''])
            ]);
            commentsWrap.appendChild(item);
          });
        });

        // Comment form
        const form = card.querySelector('[data-field="commentForm"]');
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          if (!currentUser) {
            alert("Login first!");
            return;
          }
          const data = new FormData(form);
          const text = (data.get('text') || '').toString().trim();
          if (!text) return;
          try {
            await addDoc(collection(db, 'missions', id, 'comments'), {
              text,
              author: currentUser.uid,
              authorName: currentUser.email || "anon",
              createdAt: serverTimestamp(),
            });
            form.reset();
          } catch (e2) { alert('Failed to post: ' + (e2?.message || e2)); }
        });

        missionsEl.appendChild(card);
      });
    }
    // Disable Add Mission if not logged in
    addBtn.disabled = true;
  </script>
</body>
</html>
