<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mission Tracker (Category Admins + Superadmin)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="robots" content="noindex" />
  <style>
    body {
      min-height: 100vh;
      background: linear-gradient(180deg, #e8eefe 0%, #ffffff 100%);
    }
    #missions:empty::after {
      content: "No missions yet. Click 'Add Mission' to begin.";
      display: block;
      color: #999;
      text-align: center;
      margin-top: 2rem;
      font-size: 1.125rem;
    }
    .admin-only { display: none; }
    .admin-visible { display: inline-block !important; }
    .feedback-list { max-height: 110px; overflow-y: auto; }
    .feedback-item { background: #f1f5f9; border-radius: 0.5rem; padding: 0.5rem; margin-bottom: 0.25rem; font-size:0.98em;}
  </style>
</head>
<body class="bg-gray-50 text-gray-800 flex flex-col items-center py-10 px-4">
  <div class="w-full max-w-2xl">

    <header class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-black tracking-tight text-blue-800">Mission Tracker</h1>
    </header>

    <!-- Auth Box -->
    <div id="authBox" class="bg-white p-6 rounded shadow max-w-md w-full mb-8">
      <h2 class="text-xl font-semibold mb-4">Sign in or Register</h2>
      <input id="authEmail" type="email" placeholder="Email" class="border p-2 w-full mb-2 rounded" autocomplete="username" />
      <input id="authPass" type="password" placeholder="Password" class="border p-2 w-full mb-2 rounded" autocomplete="current-password" />
      <div class="flex gap-2 mb-2">
        <button id="loginBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Login</button>
        <button id="registerBtn" class="bg-gray-600 text-white px-4 py-2 rounded">Register</button>
        <button id="logoutBtn" class="bg-red-600 text-white px-4 py-2 rounded hidden">Logout</button>
      </div>
      <div id="authStatus" class="text-sm text-gray-700 mt-3"></div>
    </div>

    <!-- Category Tabs -->
    <div id="categoryTabs" class="flex gap-2 mb-4">
      <button class="cat-tab px-4 py-2 rounded font-semibold bg-blue-100 text-blue-800" data-cat="all">All</button>
      <button class="cat-tab px-4 py-2 rounded font-semibold bg-gray-100 text-gray-700" data-cat="תקשוב">תקשוב</button>
      <button class="cat-tab px-4 py-2 rounded font-semibold bg-gray-100 text-gray-700" data-cat="לוגיסטיקה">לוגיסטיקה</button>
      <button class="cat-tab px-4 py-2 rounded font-semibold bg-gray-100 text-gray-700" data-cat="רכב">רכב</button>
      <button class="cat-tab px-4 py-2 rounded font-semibold bg-gray-100 text-gray-700" data-cat="מטבח">מטבח</button>
      <button class="cat-tab px-4 py-2 rounded font-semibold bg-gray-100 text-gray-700" data-cat="מחנה">מחנה</button>
    </div>

    <div class="flex flex-wrap items-center gap-3 mb-2">
      <button id="addBtn" class="bg-blue-600 hover:bg-blue-700 transition text-white px-5 py-2 rounded font-semibold shadow">Add Mission</button>
      <div class="ml-auto flex items-center gap-2">
        <span class="text-gray-500">User:</span>
        <span id="userEmailDisplay" class="font-semibold text-blue-700"></span>
        <span id="adminBadge" class="admin-only bg-blue-600 text-white px-2 py-1 rounded text-xs font-bold">Admin</span>
        <span id="superBadge" class="admin-only bg-red-600 text-white px-2 py-1 rounded text-xs font-bold">Superadmin</span>
      </div>
    </div>

    <div id="missions" class="mt-6 grid gap-5"></div>
  </div>

  <!-- Modal: Create / Edit Mission -->
  <div id="formModal" class="hidden fixed inset-0 bg-black/50 z-20 flex justify-center items-center">
    <div class="bg-white p-6 rounded shadow max-w-md w-full">
      <h2 class="text-xl font-semibold mb-4" id="formTitle">New Mission</h2>
      <select id="category" class="border p-2 w-full mb-2 rounded" required>
        <option value="">Select category</option>
        <option value="תקשוב">תקשוב</option>
        <option value="לוגיסטיקה">לוגיסטיקה</option>
        <option value="רכב">רכב</option>
        <option value="מטבח">מטבח</option>
        <option value="מחנה">מחנה</option>
      </select>
      <input id="title" placeholder="Title" class="border p-2 w-full mb-2 rounded" />
      <textarea id="description" placeholder="Description" class="border p-2 w-full mb-2 rounded"></textarea>
      <input id="deadline" type="date" class="border p-2 w-full mb-2 rounded" />
      <select id="status" class="border p-2 w-full mb-4 rounded">
        <option>Pending</option>
        <option>In Progress</option>
        <option>Complete</option>
      </select>
      <div class="flex justify-end gap-2">
        <button id="cancelBtn" class="px-4 py-2">Cancel</button>
        <button id="saveBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Save</button>
      </div>
    </div>
  </div>

  <template id="missionCardTpl">
    <div class="mission-card p-5 bg-white rounded shadow transition">
      <div class="flex items-start justify-between gap-4">
        <div class="min-w-0">
          <div class="flex gap-2 items-center mb-1">
            <span class="inline-block text-xs px-2 py-1 rounded bg-blue-50 text-blue-700 font-bold" data-field="category"></span>
            <h3 class="font-bold text-lg truncate" data-field="title">Title</h3>
          </div>
          <p class="mt-1" data-field="description">Description…</p>
          <p class="mt-1 text-sm text-gray-500" data-field="meta">—</p>
        </div>
        <div class="flex-shrink-0 space-x-2">
          <button class="edit underline text-blue-600 hover:text-blue-900">Edit</button>
          <button class="delete underline text-red-600 hover:text-red-800 admin-only">Delete</button>
        </div>
      </div>
      <!-- Feedback Section -->
      <div class="mt-3">
        <div class="feedback-list text-sm mb-2"></div>
        <div class="flex gap-1">
          <input class="feedback-input border p-1 rounded flex-1" type="text" maxlength="300" placeholder="Add feedback..." />
          <button class="feedback-submit bg-blue-100 text-blue-800 px-2 rounded">Send</button>
        </div>
      </div>
    </div>
  </template>

  <script type="module">
    // --- Firebase SDK (v10) ---
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import {
      getFirestore, collection, addDoc, doc, updateDoc, deleteDoc,
      onSnapshot, serverTimestamp, query, orderBy,
      getDocs, writeBatch, getDoc, setDoc
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // --- Your Firebase project ---
    const firebaseConfig = {
      apiKey: "AIzaSyA7B7rovUIpikVGepAqQI2s3Y_xePEwkSA",
      authDomain: "missiontracker-52bb7.firebaseapp.com",
      projectId: "missiontracker-52bb7",
      storageBucket: "missiontracker-52bb7.appspot.com",
      messagingSenderId: "1029768338042",
      appId: "1:1029768338042:web:23b2a0539e0aab53daf9c3",
      measurementId: "G-TNVPW8RETF"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- Auth UI and Logic ---
    const authEmail = document.getElementById('authEmail');
    const authPass = document.getElementById('authPass');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const authStatus = document.getElementById('authStatus');
    const userEmailDisplay = document.getElementById('userEmailDisplay');
    const adminBadge = document.getElementById('adminBadge');
    const superBadge = document.getElementById('superBadge');
    const addBtn = document.getElementById('addBtn');

    let currentUser = null;
    let isAdmin = false;
    let isSuperAdmin = false;
    let allowedCategories = [];

    // Check if user is admin (admins collection: admins/{uid} exists)
    async function checkIfAdmin(uid) {
      try {
        const docRef = doc(db, "admins", uid);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          const data = docSnap.data();
          allowedCategories = Array.isArray(data.categories) ? data.categories : [];
          isSuperAdmin = !!data.superadmin || (data.email === "admin@admins.com");
          isAdmin = true;
        } else {
          allowedCategories = [];
          isSuperAdmin = false;
          isAdmin = false;
        }
      } catch (e) {
        allowedCategories = [];
        isSuperAdmin = false;
        isAdmin = false;
      }
    }

    function updateAdminUI() {
      document.querySelectorAll('.admin-only').forEach(el => {
        el.classList.toggle("admin-visible", isAdmin);
      });
      adminBadge.classList.toggle("admin-visible", isAdmin && !isSuperAdmin);
      superBadge.classList.toggle("admin-visible", isSuperAdmin);
    }

    // Auth state listener
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        userEmailDisplay.textContent = user.email;
        logoutBtn.classList.remove("hidden");
        loginBtn.classList.add("hidden");
        registerBtn.classList.add("hidden");
        authEmail.classList.add("hidden");
        authPass.classList.add("hidden");
        addBtn.disabled = false;
        await checkIfAdmin(user.uid);
        updateAdminUI();
        if (isSuperAdmin) {
          authStatus.textContent = "Logged in as: " + user.email + " (Superadmin)";
        } else if (isAdmin) {
          authStatus.textContent = "Logged in as: " + user.email + " (Admin for: " + allowedCategories.join(", ") + ")";
        } else {
          authStatus.textContent = "Logged in as: " + user.email;
        }
      } else {
        currentUser = null;
        userEmailDisplay.textContent = "";
        logoutBtn.classList.add("hidden");
        loginBtn.classList.remove("hidden");
        registerBtn.classList.remove("hidden");
        authEmail.classList.remove("hidden");
        authPass.classList.remove("hidden");
        addBtn.disabled = true;
        authStatus.textContent = "Not logged in.";
        isAdmin = false;
        isSuperAdmin = false;
        allowedCategories = [];
        updateAdminUI();
      }
    });

    // Login
    loginBtn.onclick = async () => {
      try {
        await signInWithEmailAndPassword(auth, authEmail.value, authPass.value);
        authStatus.textContent = "Logging in...";
      } catch (e) {
        authStatus.textContent = "Login failed: " + e.message;
      }
    };

    // Register (allow any email for demo)
    registerBtn.onclick = async () => {
      try {
        const cred = await createUserWithEmailAndPassword(auth, authEmail.value, authPass.value);
        await setDoc(doc(db, "users", cred.user.uid), {
          email: cred.user.email,
          createdAt: new Date()
        });
        authStatus.textContent = "Registered!";
      } catch (e) {
        authStatus.textContent = "Registration failed: " + e.message;
      }
    };

    // Logout
    logoutBtn.onclick = () => signOut(auth);

    // --- UI refs ---
    const missionsEl = document.getElementById('missions');
    const modal = document.getElementById('formModal');
    const formTitle = document.getElementById('formTitle');
    const titleEl = document.getElementById('title');
    const descEl = document.getElementById('description');
    const deadlineEl = document.getElementById('deadline');
    const statusEl = document.getElementById('status');
    const cancelBtn = document.getElementById('cancelBtn');
    const categoryEl = document.getElementById('category');
    const categoryTabs = document.querySelectorAll('.cat-tab');

    let editingId = null; // Firestore doc id when editing
    let missionsCache = [];
    let selectedCategory = "all";

    // Category filter
    categoryTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        categoryTabs.forEach(t => t.classList.remove('bg-blue-100', 'text-blue-800'));
        tab.classList.add('bg-blue-100', 'text-blue-800');
        selectedCategory = tab.dataset.cat;
        renderMissions();
      });
    });

    function openForm(isEdit = false) {
      if (!currentUser) {
        alert("You must be logged in to add or edit missions.");
        return;
      }
      formTitle.textContent = isEdit ? 'Edit Mission' : 'New Mission';
      modal.classList.remove('hidden');
    }
    function closeForm() {
      modal.classList.add('hidden');
      editingId = null;
      titleEl.value = '';
      descEl.value = '';
      deadlineEl.value = '';
      statusEl.value = 'Pending';
      categoryEl.value = '';
    }

    cancelBtn.addEventListener('click', closeForm);
    addBtn.addEventListener('click', () => {
      if (!currentUser) {
        alert("Login first!");
        return;
      }
      openForm(false);
    });

    // --- Firestore collections ---
    const missionsCol = collection(db, 'missions');

    // Create or update mission
    document.getElementById('saveBtn').addEventListener('click', async () => {
      if (!currentUser) {
        alert("You must be logged in to save a mission.");
        return;
      }
      const payload = {
        title: titleEl.value.trim() || 'Untitled',
        description: descEl.value.trim(),
        deadline: deadlineEl.value || null,
        status: statusEl.value,
        updatedAt: serverTimestamp(),
        category: categoryEl.value || '',
        creator: currentUser.email || currentUser.uid
      };
      if (!payload.category) {
        alert("Please select a category.");
        return;
      }

      // Only allow add/edit if admin for that category or superadmin
      if (!(isSuperAdmin || (isAdmin && allowedCategories.includes(payload.category)))) {
        alert("You are not the admin for category: " + payload.category);
        return;
      }

      try {
        if (editingId) {
          await updateDoc(doc(db, 'missions', editingId), payload);
        } else {
          await addDoc(missionsCol, {
            ...payload,
            createdAt: serverTimestamp(),
          });
        }
        closeForm();
      } catch (e) {
        alert('Failed to save mission: ' + e.message);
      }
    });

    // Delete mission + all comments (batched) -- only admins for that category or superadmin
    async function deleteMissionAndComments(id, category) {
      if (!(isSuperAdmin || (isAdmin && allowedCategories.includes(category)))) {
        alert("You are not the admin for category: " + category);
        return;
      }
      if (!confirm('Delete this mission and all its feedback?')) return;
      try {
        const missionRef = doc(db, 'missions', id);
        const commentsRef = collection(missionRef, 'comments');
        const commentsSnap = await getDocs(commentsRef);

        const batch = writeBatch(db);
        commentsSnap.forEach(c => batch.delete(c.ref));
        batch.delete(missionRef);
        await batch.commit();
      } catch (err) {
        alert('Delete failed: ' + (err?.message || err));
      }
    }

    // --- Feedback Logic ---
    function renderFeedbackSection(missionId, cardEl) {
      const feedbackList = cardEl.querySelector('.feedback-list');
      const feedbackInput = cardEl.querySelector('.feedback-input');
      const feedbackSubmit = cardEl.querySelector('.feedback-submit');
      feedbackInput.value = "";

      // Listen for comments in real-time
      const commentsCol = collection(db, 'missions', missionId, 'comments');
      onSnapshot(commentsCol, (snap) => {
        feedbackList.innerHTML = '';
        snap.forEach(doc => {
          const data = doc.data();
          const div = document.createElement('div');
          div.className = 'feedback-item';
          div.innerHTML = `<b>${data.author || 'Anonymous'}:</b> ${data.text}`;
          feedbackList.appendChild(div);
        });
      });

      feedbackSubmit.onclick = async () => {
        if (!currentUser) {
          alert("Login to leave feedback.");
          return;
        }
        if (feedbackInput.value.trim() === '') return;
        await addDoc(commentsCol, {
          text: feedbackInput.value,
          author: currentUser ? currentUser.email : 'Anonymous',
          createdAt: serverTimestamp()
        });
        feedbackInput.value = '';
      };
    }

    // Subscribe to missions in real-time
    const qMissions = query(missionsCol, orderBy('createdAt', 'desc'));
    onSnapshot(qMissions, (snap) => {
      missionsCache = [];
      snap.forEach((docSnap) => {
        const m = docSnap.data();
        const id = docSnap.id;
        missionsCache.push({ ...m, id });
      });
      renderMissions();
    });

    function renderMissions() {
      missionsEl.innerHTML = '';
      const tpl = document.getElementById('missionCardTpl');
      let filtered = missionsCache;
      if (selectedCategory !== "all") {
        filtered = filtered.filter(m => m.category === selectedCategory);
      }
      filtered.forEach((m) => {
        const id = m.id;
        const card = tpl.content.cloneNode(true);
        const cardEl = card.children[0];

        cardEl.querySelector('[data-field="category"]').textContent = m.category || '';
        cardEl.querySelector('[data-field="title"]').textContent = m.title || 'Untitled';
        cardEl.querySelector('[data-field="description"]').textContent = m.description || '';
        const meta = [];
        meta.push('Status: ' + (m.status || 'Pending'));
        meta.push('Deadline: ' + (m.deadline || '—'));
        meta.push('Created by: ' + (m.creator || '—'));
        cardEl.querySelector('[data-field="meta"]').textContent = meta.join(' | ');

        // Edit
        const editBtn = cardEl.querySelector('.edit');
        const canEdit = isSuperAdmin || (isAdmin && allowedCategories.includes(m.category));
        if (canEdit) {
          editBtn.style.display = '';
        } else {
          editBtn.style.display = 'none';
        }
        editBtn.addEventListener('click', () => {
          if (!currentUser) {
            alert("Login first!");
            return;
          }
          if (!canEdit) {
            alert("You are not the admin for category: " + m.category);
            return;
          }
          editingId = id;
          titleEl.value = m.title || '';
          descEl.value = m.description || '';
          deadlineEl.value = m.deadline || '';
          statusEl.value = m.status || 'Pending';
          categoryEl.value = m.category || '';
          openForm(true);
        });

        // Delete (mission + comments) -- only admins for that category or superadmin
        const deleteBtn = cardEl.querySelector('.delete');
        if (canEdit) {
          deleteBtn.classList.add("admin-visible");
        } else {
          deleteBtn.classList.remove("admin-visible");
        }
        deleteBtn.addEventListener('click', () => deleteMissionAndComments(id, m.category));

        // Feedback
        renderFeedbackSection(id, cardEl);

        missionsEl.appendChild(card);
      });
    }
    // Disable Add Mission if not logged in
    addBtn.disabled = true;
  </script>
</body>
</html>
